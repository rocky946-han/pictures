[TOC]

文档密级：公司内部AA

# 1. 概述

## 1.1. 编写目的与范围

​		本文档主要承担PRM2.0系统设计方案，说明集成模块的设计详情，包括程序功能描述，数据输入和输出，算法以及逻辑处理，接口描述。本文档将随着系统的开发逐步完善，为系统的开发和维护提供基础依据

## 1.2. 引用文档

| 序号 | 文档名称                                               | 作者   | 发布日期   | 存放目录                                                     |
| ---- | ------------------------------------------------------ | ------ | ---------- | ------------------------------------------------------------ |
| 1    | PRM2.0系统需求规格说明书_v1.0_20211112.docx            | 李涛   | 2021-11-12 | management\04.Requirement\需求文档\二期需求\02 需求规格说明书 |
| 2    | PRM系统2.0版功能原型_v1.1_20211119.rp                  | 刘慧娟 | 2021-11-19 | management\04.Requirement\需求文档\二期需求\04 功能原型      |
| 3    | 权限配置清单（待提供）                                 | 李涛   |            |                                                              |
| 4    | 《工作流引擎-接口设计说明书》-rest版-对接渠道-20211129 | 宋子寒 | 2021-11-29 | management\05.Design\详细设计\第三方集成                     |
| 5    | 3-06-02-契约锁私有化系统JavaSDK接口文档                | 杨鹏程 | 2020-10-29 | management\05.Design\详细设计\第三方集成                     |
| 6    | PRM数据库设计.pdman.json                               | 黄梦晗 | 2021-12-06 | management\05.Design\详细设计\数据库设计                     |
| 7    | 数据字典详细设计文档                                   | 黄梦晗 | 2021-12-03 | management\05.Design\详细设计                                |

## 1.3. 修改记录

| 序号 | 作者   | 修改日期   | 备注               |
| ---- | ------ | ---------- | ------------------ |
| 1    | 黄梦晗 | 2021-12-03 | 二期全功能详细设计 |

# 2. 关键功能详细设计

## 2.1. 互动支持-市场秩序

### 2.1.1. 审批流程

![image-20211123165908873](https://gitee.com/rocky946/pictures/raw/master/img/image-20211123165908873.png)

1. 渠道端发起申报审批流程，讯飞端审核
2. 流程命名规则：市场秩序-项目名称-提交日期，如：市场秩序-XXX-20211109
3. 创建流程时将申报编号传至流程引擎
4. 在T_WORKFLOW_BASE[流程基本信息]、T_WORKFLOW_NODE[流程节点]表中配置流程信息
3. 申请人节点
   1. 由于渠道商是外部用户，无法创建流程，故流程引擎创建虚拟虚拟账号， PRM调用创建流程接口的时候使用
   2. 业务表里的申请人还是当前登陆人
   2. 在uap中配置**审批节点 + 业务线大类**审批角色
   4. 在T_WORKFLOW_APPROVER_ROLE_MAP[流程审批人角色映射]表中配置角色映射，条件表达式包含：
      * 当前节点编码：第一次提交时还没有创建流程，默认当前节点是申请人节点
      * 业务线大类编码
4. 市场秩序负责人节点
   1. 审批按钮：同意、不同意、转办、意见征询
   2. 在uap中配置**审批节点 + 业务线大类**审批角色
   3. 在T_WORKFLOW_APPROVER_ROLE_MAP[流程审批人角色映射]表中配置角色映射，条件表达式包含：
      * 当前节点编码：取表单中当前节点编码字段（市场秩序负责人节点）
      * 业务线大类编码
5. 协同处理人节点
   1. 协同处理人为市场秩序负责人审批时自选
   2. 审批按钮：反馈
   3. 填写反馈意见、上传附件
6. 决策人节点
   1. 审批按钮：同意、不同意、转办
   2. 不同意：逐级退回，到市场秩序负责人节点
9. 前端提供PC端和i讯飞统一待办页面URL给流程引擎配置

### 2.1.2. 渠道端-应用管理

![image-20211123172647881](https://gitee.com/rocky946/pictures/raw/master/img/image-20211123172647881.png)

菜单权限：在讯飞端-内容管理-应用管理中新建应用，根据业务需求配置权限，应用图标待提供

### 2.1.3. 渠道端-新建

表单字段：

| 序号 | 字段           | 类型   | 是否必填 | 备注                                                         |
| ---- | -------------- | ------ | -------- | ------------------------------------------------------------ |
| 1    | 业务线大类     | 下拉框 | 是       | 同商机报备-查询报备业务接口，前端传业务线大类编码给后端存储  |
| 2    | 项目名称       | 文本   | 是       | 长度：100                                                    |
| 3    | 客户名称       | 文本   | 是       | 长度：100                                                    |
| 4    | 项目金额       | 文本   | 是       | 长度：50，单位用户自填                                       |
| 5    | 讯飞负责人     | 文本   | 是       | 长度：50，可填无                                             |
| 6    | 负责人联系方式 | 文本   | 是       | 可填无，不校验手机号                                         |
| 7    | 申报详情       | 文本   | 否       | 长度：4000                                                   |
| 8    | 举证材料       | 附件   | 否       | 类型：txt,pdf,doc,docx,md,bmp,png,jpg,jpeg,gif,xls,xlsx,ppt,pptx,zip,7z,mp3,wav,mp4,flv；大小：200m；限制数量：5 |
| 9    | 关联商机       | 搜索框 | 否       | 1. 临时用户只可搜索自己报备的商机<br />2. 注册用户可搜索本公司报备的商机<br />3. 后端查询商机列表接口，先判断当前登录用户类型，若为临时用户，创建人参数设置为当前登陆人；若为注册用户，公司参数设置为当前登录人所属公司<br />4. 商机编码精确搜索，商机名称模糊搜索<br />5. 限制只展示前20条，单选<br />6. 后端只存关联商机编码 |
| 10   | 关联商机编码   | 文本   | 否       | 只读，选择关联报备商机后自动带出                             |

前端将以上表单字段提交到后端创建流程接口：

1. 后端做相关必填、格式等校验

2. 生成申报编号：SCZX+YYYY-MM-DD+3位流水号

3. 查询市场秩序负责人：
   1. 根据当前节点（此处默认是申请人节点）、表单填写的业务线大类，查询流程审批人角色映射表获得对应的市场秩序负责人角色编码
   2. 根据负责人角色编码，调用uap通过角色编码获取人员接口，获得对应的负责人
   3. 将负责人保存到当前审批人字段：姓名[域账号]，多个审批人以英文逗号拼接
   
4. 包装相应参数，调用流程引擎创建流程接口，返回流程实例ID，将其保存到instanceId字段

   > 将申报编号传到流程引擎

5. 设置当前审批节点：市场秩序负责人节点

6. 设置申请相关字段
   1. 申请人ID：当前登录人ID，LoginUser中获取
   2. 申请时间：当前时间，new Date()
   3. 渠道商ID：当前登录人所属渠道商channelId，LoginUser中获取
   3. 审批状态：审批中
   
7. 设置创建、更新相关6个字段

8. 保存业务数据到数据库：
   1. 保存举证材料到附件表
   2. 保存主表数据到市场秩序申报表


### 2.1.4. 渠道端-分页列表

1. 数据权限：临时用户仅可查看本人申报信息，注册用户可查看本公司内所有用户申报信息

   * 后端分页列表接口，先判断当前登录用户类型，若为临时用户，创建人参数设置为当前登陆人
   * 若为注册用户，公司参数设置为当前登录人所属公司
   
2. 查询条件：

   | 序号 | 字段       | 类型       | 备注                                                         |
   | ---- | ---------- | ---------- | ------------------------------------------------------------ |
   | 1    | 业务线大类 | 下拉框     | 同商机报备-查询报备业务接口，前端传业务线大类编码给后端；精确查询 |
   | 2    | 项目名称   | 文本       | 模糊查询                                                     |
   | 3    | 客户名称   | 文本       | 模糊查询                                                     |
   | 4    | 审批状态   | 下拉框     | 调用根据字典类型获取子字典接口；精确查询                     |
   | 5    | 申报时间   | 日期选择框 | YYYY-MM-DD                                                   |
   | 6    | 判断结果   | 下拉框     | 调用根据字典类型获取子字典接口；精确查询                     |

3. 排序：申报时间倒序

4. 分页参数同其它模块

5. 分页列表接口返回字段：

   | 序号 | 字段           | 是否展示 | 备注                                                         |
   | ---- | -------------- | -------- | ------------------------------------------------------------ |
   | 1    | ID             | 否       |                                                              |
   | 2    | 申报编号       | 是       |                                                              |
   | 3    | 业务线大类编码 | 否       |                                                              |
   | 4    | 业务线大类名称 | 是       | 1. 前端列名：业务线大类；<br />2. 关联产品线线表查询，类型：B，模块：商机报备 |
   | 5    | 项目名称       | 是       |                                                              |
   | 6    | 客户名称       | 是       |                                                              |
   | 7    | 申报人ID       | 否       |                                                              |
   | 8    | 申报人姓名     | 是       | 1. 前端列名：申报人<br />2. 关联渠道商用户表查询             |
   | 9    | 申报时间       | 是       | 格式：YYYY-MM-DD                                             |
   | 10   | 当前审批人     | 是       | 姓名[域账号]，多个以英文逗号连接                             |
   | 11   | 审批状态编码   | 否       |                                                              |
   | 12   | 审批状态名称   | 是       | 1. 前端列名：审批状态<br />2. 关联子字典表查询               |
   | 13   | 判定结果编码   | 否       |                                                              |
   | 14   | 判定结果名称   | 是       | 1. 前端列名：判定结果<br />2. 关联字典表查询                 |
   | 15   | instanceId     | 否       | 用于前端点击查看详情调用获取审批记录接口                     |

   **注：若列表展示不全，前端根据实际情况判断，列表中固定申报编号、业务线大类、项目名称、客户名称、审批状态、判定结果字段，其他字段采用滑动的方式查**

### 2.1.5. 渠道端-查看详情

后端提供接口：

1. 根据ID查询基础市场秩序申报详情接口，返回字段：

   | 序号 | 字段           | 是否展示 | 备注                                                         |
   | ---- | -------------- | -------- | ------------------------------------------------------------ |
   | 1    | ID             | 否       |                                                              |
   | 2    | 申报编号       | 是       |                                                              |
   | 3    | 业务线大类编码 | 否       |                                                              |
   | 4    | 业务线大类名称 | 是       | 1. 前端列名：业务线大类；<br />2. 关联产品线线表查询，类型：B，模块：商机报备 |
   | 5    | 项目名称       | 是       |                                                              |
   | 6    | 客户名称       | 是       |                                                              |
   | 7    | 项目金额       | 是       |                                                              |
   | 8    | 讯飞负责人     | 是       |                                                              |
   | 9    | 负责人联系方式 | 是       |                                                              |
   | 10   | 申报详情       | 是       |                                                              |
   | 11   | 举证材料       | 是       | 先查询市场秩序申报详情，再通过ID、附件业务类型获取附件信息DTO，放入市场秩序申报DTO中 |
   | 12   | 关联商机编码   | 是       |                                                              |
   | 13   | 关联商机       | 是       | 关联商机线索表查询                                           |
   | 14   | 处理意见       | 是       |                                                              |
   | 15   | 判定结果编码   | 否       |                                                              |
   | 16   | 判定结果名称   | 是       | 1. 前端字段名：判定结果<br />2. 关联字典表查询               |
   | 17   | 所属渠道商ID   | 否       |                                                              |
   | 18   | 所属渠道商名称 | 是       | 1. 前端字段：所属渠道商<br />2. 关联商机线索流程表查询，参考商机线索模块 |
   | 19   | 申报人ID       | 否       |                                                              |
   | 20   | 申报人姓名     | 是       | 1. 前端字段：申报人<br />2. 关联渠道商用户表查询             |
   | 21   | 申报时间       | 是       | 格式：YYYY-MM-DD HH:MM:SS                                    |
   | 22   | 审批状态编码   | 否       |                                                              |
   | 23   | 审批状态名称   | 是       | 1. 前端字段名：审批状态<br />2. 关联子字典表查询             |
   | 24   | 当前审批人     | 是       | 姓名[域账号]，多个以英文逗号连接                             |
   | 25   | taskId         | 否       | 用于调用流程引擎相关接口                                     |
   | 26   | instanceId     | 否       | 用于调用流程引擎相关接口                                     |

2. 根据instanceId查询流程审批记录接口：公共接口

### 2.1.6. 渠道端-编辑

1. 对于被驳回的申报，申请人可在详情页面点击编辑按钮，新建时的全字段可编辑
2. 表单字段同[渠道端-新建](#2.1.1.2.1. 新建)
4. 前端将以上表单字段提交到后端resubmit接口：
   1. 后端做相关必填、格式等校验
   3. 查询市场秩序负责人：
      1. 根据表单当前节点（申请人节点），表单填写的业务线大类，查询流程审批人角色映射表获得对应的市场秩序负责人角色编码
      2. 根据负责人角色编码，调用uap通过角色编码获取人员接口，获得对应的负责人
      3. 将负责人保存到当前审批人字段：姓名[域账号]，多个审批人以英文逗号拼接
   3. 包装相应参数，调用流程引擎提交流程实例接口
   3. 设置审批状态：审批中
   4. 设置当前审批节点：市场秩序负责人节点
   5. 置空taskId
   6. 设置更新相关3个字段
   6. 保存业务数据到数据库：
      1. 保存举证材料到附件表（先全部删除，再全部插入）
      2. 保存主表数据到市场秩序申报表

### 2.1.7. 渠道端-删除

1.  对于被驳回的申报，申请人可在详情页面点击编辑按钮，
2.  后端提供根据ID删除市场秩序申报接口：
   1.  **参数：ID**
   2.  校验ID必填
   3.  根据ID获取市场秩序信息（不同于查询详情接口，只需调用Mybatis Plus getById方法即可）
   4.  判断是否存在
       1.  不存在，直接返回，提示”操作失败，查询不到数据！“
       2.  若存在，继续执行以下逻辑

   5.  获取到instanceId，以及判断当前审批状态是否是驳回：
       1.  否，直接返回，提示"当前数据已更改，不可操作！"
       2.  是，继续执行以下逻辑
   6.  根据instanceId调用流程引擎删除流程接口
   7.  根据ID、附件业务类型删除附件表中的举证材料
   8.  删除市场秩序申报表业务数据


### 2.1.8. 讯飞端-分页列表

同[渠道端-分页列表](#2.1.1.2.2. 分页列表)，差异：

1. 菜单权限：根据业务提供的权限配置文档在uap中配置

1. 数据权限：根据业务提供的权限配置文档在uap中配置，根据**业务线大类**配置数据权限

2. 分页列表接口返回字段新增：

   | 序号 | 字段           | 是否展示 | 备注                                                         |
   | ---- | -------------- | -------- | ------------------------------------------------------------ |
   | 1    | 所属渠道商ID   | 否       |                                                              |
   | 2    | 所属渠道商名称 | 是       | 1. 前端列表名：所属渠道商<br />2. 关联商机线索流程表查询，参考商机线索模块 |

### 2.1.9. 讯飞端-导出

1. 菜单权限：根据业务提供的权限配置文档在uap中配置

1. 数据权限、查询条件同分页列表

2. 不分页

3. 列表查询接口返回字段：

   | 序号 | 字段           | 是否导出 | 备注                                                         |
   | ---- | -------------- | -------- | ------------------------------------------------------------ |
   | 1    | ID             | 否       |                                                              |
   | 2    | 申报编号       | 是       |                                                              |
   | 3    | 业务线大类编码 | 否       |                                                              |
   | 4    | 业务线大类名称 | 是       | 1. Excel列名：业务线大类；<br />2. 关联产品线线表查询，类型：B，模块：商机报备 |
   | 5    | 项目名称       | 是       |                                                              |
   | 6    | 客户名称       | 是       |                                                              |
   | 7    | 项目金额       | 是       |                                                              |
   | 8    | 讯飞负责人     | 是       |                                                              |
   | 9    | 负责人联系方式 | 是       |                                                              |
   | 10   | 申报详情       | 是       |                                                              |
   | 11   | 关联商机       | 是       | 关联商机线索表查询                                           |
   | 12   | 关联商机编码   | 是       |                                                              |
   | 13   | 所属渠道商ID   | 否       |                                                              |
   | 14   | 所属渠道商名称 | 是       | 1. Excel列名：所属渠道商<br />2. 关联商机线索流程表查询，参考商机线索模块 |
   | 15   | 申报人ID       | 否       |                                                              |
   | 16   | 申报人姓名     | 是       | 1. Excel列名：申报人<br />2. 关联渠道商用户表查询            |
   | 17   | 申报时间       | 是       | 格式：YYYY-MM-DD                                             |
   | 18   | 审批状态编码   | 否       |                                                              |
   | 19   | 审批状态名称   | 是       | 1. Excel列名：审批状态<br />2. 关联子字典表查询              |
   | 20   | 当前审批人     | 是       | 姓名[域账号]，多个以英文逗号连接                             |
   | 21   | 反馈人域账号   | 否       |                                                              |
   | 22   | 反馈人姓名     | 否       | 关联讯飞用户表查询                                           |
   | 23   | 反馈人         | 是       | 由反馈人姓名、反馈人域账号组成，展示成：姓名[域账号]         |
   | 24   | 反馈时间       | 是       | 格式：YYYY-MM-DD HH:MM:SS                                    |
   | 25   | 反馈意见       | 是       |                                                              |
   | 26   | 处理意见       | 是       |                                                              |
   | 27   | 判定结果编码   | 否       |                                                              |
   | 28   | 判定结果名称   | 是       | 1. Excel列名：判定结果<br />2. 关联字典表查询                |

   **注：使用EasyExcel导出，若开发时组件不支持合并单元格，则申报编号、反馈人、反馈时间、反馈意见则在第二个sheet导出**

### 2.1.10. 讯飞端-查看详情

后端提供接口：

1. 根据ID查询基础市场秩序申报详情接口，返回字段：

   | 序号 | 字段               | 是否展示 | 备注                                                         |
   | ---- | ------------------ | -------- | ------------------------------------------------------------ |
   | 1    | ID                 | 否       |                                                              |
   | 2    | 申报编号           | 是       |                                                              |
   | 3    | 业务线大类编码     | 否       |                                                              |
   | 4    | 业务线大类名称     | 是       | 1. 前端列名：业务线大类；<br />2. 关联产品线线表查询，类型：B，模块：商机报备 |
   | 5    | 项目名称           | 是       |                                                              |
   | 6    | 客户名称           | 是       |                                                              |
   | 7    | 项目金额           | 是       |                                                              |
   | 8    | 讯飞负责人         | 是       |                                                              |
   | 9    | 负责人联系方式     | 是       |                                                              |
   | 10   | 申报详情           | 是       |                                                              |
   | 11   | 举证材料           | 是       | 先查询市场秩序申报详情，再通过ID、附件业务类型获取附件信息DTO，放入市场秩序申报DTO中 |
   | 12   | 关联商机编码       | 是       |                                                              |
   | 13   | 关联商机           | 是       | 关联商机线索表查询                                           |
   | 14   | 处理意见           | 是       |                                                              |
   | 15   | 判定结果编码       | 否       |                                                              |
   | 16   | 判定结果名称       | 是       | 1. 前端字段名：判定结果<br />2. 关联字典表查询               |
   | 17   | 所属渠道商ID       | 否       |                                                              |
   | 18   | 所属渠道商名称     | 是       | 1. 前端字段：所属渠道商<br />2. 关联商机线索流程表查询，参考商机线索模块 |
   | 19   | 申报人ID           | 否       |                                                              |
   | 20   | 申报人姓名         | 是       | 1. 前端字段：申报人<br />2. 关联渠道商用户表查询             |
   | 21   | 申报时间           | 是       | 格式：YYYY-MM-DD HH:MM:SS                                    |
   | 22   | 审批状态编码       | 否       |                                                              |
   | 23   | 审批状态名称       | 是       | 1. 前端字段名：审批状态<br />2. 关联子字典表查询             |
   | 24   | 当前审批人         | 是       | 姓名[域账号]，多个以英文逗号连接                             |
   | 25   | 协同人处理相关信息 | 是       | 参考下方协同人处理相关信息注释                               |
   | 26   | taskId             | 否       | 用于调用流程引擎相关接口                                     |
   | 27   | instanceId         | 否       | 用于调用流程引擎相关接口                                     |

   协同人处理相关信息：

   1. 先查询市场秩序申报详情，然后意见征询表左关联附件表，最终得到意见征询DTO List，其中包括附件DTO List
   2. 查询条件：市场秩序申报ID
   3. 排序：反馈时间倒序
   4. 意见征询DTO：反馈人域账号（前端不展示）、反馈人姓名（前端展示，字段名：反馈人）、反馈意见、附件DTO
   5. 附件DTO：附件相关信息

2. 根据instanceId查询流程审批记录接口：公共接口

3. 根据instanceId查询流程图接口：公共接口

### 2.1.11. 讯飞端-审批

1. 审批功能位于待办中心中

2. 相关字段说明：

   | 序号 | 字段     | 类型   | 备注                                                         |
   | ---- | -------- | ------ | ------------------------------------------------------------ |
   | 1    | 处理意见 | 文本   | 长度：4000                                                   |
   | 2    | 判定结果 | 下拉框 | 1. 数据来源：调用根据业务类型获取子字典接口<br />2. 判定结果子字典值包括：1. 跨区销售（含跨区报价、跨区授权、跨区出货）；2. 恶意竞争（低价销售）；3. 正常销售行为；4. 证据不足待补充<br />3. 判定结果字典项需维护在数据字典设计文档中 |
   | 3    | 审批意见 | 文本   | 长度：666                                                    |

#### 2.1.11.1. 市场秩序负责人节点

1. 同意：处理意见、判定结果必填，点击同意按钮后，填写审批意见，然后调用后端提交流程接口：
   1. 后端做相关必填、格式等校验
   3. 查询市场秩序决策人：
      1. 根据表单当前节点（市场秩序负责人节点）、表单填写的业务线大类，查询流程审批人角色映射表获得对应的市场秩序决策人角色编码
      2. 根据决策人角色编码，调用uap通过角色编码获取人员接口，获得对应的决策人
   3. 包装相应参数，调用流程引擎提交流程实例接口
   4. 调用流程引擎获取当前审批人列表接口，更新当前审批节点、当前审批人字段。**参考`WorkFlowServiceImpl#getProcessDoingUserList`**
   5. 设置更新相关3个字段
   6. 保存主表数据到市场秩序申报表
2. 不同意：审批意见必填，流程驳回至申请人，调用后端退回流程接口：
   1. 后端做相关必填、格式等校验（审批意见必填）
   2. 设置当前审批人字段：取创建人姓名
   3. 设置审批状态：驳回
   4. 包装相应参数，调用流程引擎退回流程实例接口
   5. 设置当前审批节点：申请人节点
   6. 调用流程引擎根据流程实例id获取当前的流程Taskid，并保存到taskId字段，因为退回到申请节点时，创建人可在分页列表（非待办中心）点击详情后重新提交流程
   7. 设置更新相关3个字段
   8. 保存主表数据到市场秩序申报表
3. 转办：前端选择转办人，然后调用后端转办流程接口：
   1. 后端做相关必填、格式等校验
      1. 转办人必填，单选，前端转办人传：域账号
      2. 转办意见，文本，必填，长度：666
   2. 当前审批节点、审批状态不变
   3. 包装相应参数，调用流程引擎转办任务接口
   4. 调用流程引擎获取当前审批人列表接口，更新当前审批节点、当前审批人字段。**参考`WorkFlowServiceImpl#getProcessDoingUserList`**
   5. 设置更新相关3个字段
   6. 保存主表数据到市场秩序申报表
4. 征询：前端选择征询人，多选，然后调用后端意见征询接口：
   1. 后端做相关必填、格式等校验（征询人必填，前端征询人传：**域账号、姓名[域账号]，多个征询人以英文逗号拼接**）
   2. 当前审批节点不变
   3. 设置当前审批人字段：征询人（姓名人[域账号]）
   4. 包装相应参数，调用流程引擎意见征询接口
   5. 设置更新相关3个字段
   5. 保存主表数据到市场秩序申报表

#### 2.1.11.2. 协同处理人节点

1. 转办征询：前端选择转办人，然后调用后端**转办征询**接口：
   1. 后端做相关必填、格式等校验
      1. 转办人必填，单选，前端转办人传：域账号
      2. 转办意见，文本，必填，长度：666
   2. 当前审批节点不变
   3. 包装相应参数，调用流程引擎征询转办接口
   4. 调用流程引擎获取当前审批人列表接口，更新当前审批人字段。**参考`WorkFlowServiceImpl#getProcessDoingUserList`**
   5. 设置更新相关3个字段
   6. 保存主表数据到市场秩序申报表
   
2. 反馈：协同处理人填写反馈意见（文本；必填；长度：666）、附件（非必填；类型：；大小：200m；限制数量：5），然后调用后端反馈接口：
   1. 后端做相关必填、格式等校验（反馈意见必填，附件必填）
   2. 包装相关参数，调用流程引擎征询回复接口（反馈意见传至流程引擎）
   2. 调用流程引擎获取当前审批人列表接口，更新当前审批人字段。**参考`WorkFlowServiceImpl#getProcessDoingUserList`**
   3. 设置更新相关3个字段
   4. 保存业务数据到数据库：
      1. 保存反馈信息（反馈人域账号、反馈意见）到市场秩序意见征询表
      2. 保存反馈附件到附件表
      3. 保存主表数据到市场秩序申报表

#### 2.1.11.3. 决策人节点

1. 同意：处理意见、判定结果必填，点击同意按钮后，填写审批意见，然后调用后端提交流程接口：
   1. 后端做相关必填、格式等校验
   2. 包装相应参数，调用流程引擎提交流程实例接口
   3. 置空当前审批节点、当前审批人字段
   4. 设置审批状态：已完成
   5. 设置更新相关3个字段
   6. 保存主表数据到市场秩序申报表
2. 不同意：审批意见必填，流程驳回至市场秩序负责人节点，调用后端退回流程接口：
   1. 后端做相关必填、格式等校验（审批意见必填）
   2. 包装相应参数，调用流程引擎退回流程实例接口
   3. 调用流程引擎获取当前审批人列表接口，更新当前审批节点、当前审批人字段。**参考`WorkFlowServiceImpl#getProcessDoingUserList`**
   4. 设置审批状态：驳回
   5. 设置更新相关3个字段
   6. 保存主表数据到市场秩序申报表
3. 转办：前端选择转办人，然后调用后端转办流程接口：
   1. 后端做相关必填、格式等校验
      1. 转办人必填，单选，前端转办人传：域账号
      2. 转办意见，文本，必填，长度：666
   2. 当前审批节点、审批状态不变
   3. 包装相应参数，调用流程引擎转办任务接口
   4. 调用流程引擎获取当前审批人列表接口，更新当前审批节点、当前审批人字段。**参考`WorkFlowServiceImpl#getProcessDoingUserList`**
   5. 设置更新相关3个字段
   5. 保存主表数据到市场秩序申报表

### 2.1.12. i讯飞待办

1. 后端单独提供i讯飞接口
2. 驳回至申请节点不可操作，参考渠道签约。其它节点审批功能同PC端
3. 相关接口：
   1. 查询详情
   2. 查询审批记录：公共接口
   3. 提交
   4. 退回
   5. 转办
   6. 意见征询
   7. 征询反馈
   8. 征询转办
   8. 上传附件：公共接口，参考渠道签约

## 2.2. 互动支持-往来对账

### 2.2.1. 审批流程

![image-20211126003843804](https://gitee.com/rocky946/pictures/raw/master/img/image-20211126003843804.png)

1. 讯飞端发起往来对账审批流程，讯飞端审批
2. 流程命名规则：往来对账-渠道商公司名-提交日期，如：往来对账-XXX公司-20211109
3. 创建流程时将对账单编号传至流程引擎
4. 在T_WORKFLOW_BASE[流程基本信息]、T_WORKFLOW_NODE[流程节点]表中配置流程信息
5. 发起人节点：
   1. 在uap中配置**区域负责人**角色
   2. 在T_WORKFLOW_APPROVER_ROLE_MAP[流程审批人角色映射]表中配置角色映射，条件表达式包含：大区编码
6. 区域负责人节点：
   1. 审批按钮：同意、不同意、转办、加签、抄送
   2. 区域负责人可选择抄送人，若区域负责人直接点击同意，默认抄送至客户经理
7. 前端提供PC端和i讯飞统一待办页面URL给流程引擎配置

### 2.2.2. 签约业务流程

![image-20211126003900102](https://gitee.com/rocky946/pictures/raw/master/img/image-20211126003900102.png)

1. 讯飞端审批完成，调用契约锁根据模板创建合同接口，返回合同ID，将其保存至合同ID字段中
2. 讯飞端自动签署，调用契约锁静默签署接口，将对账状态置为待签署
3. 渠道端签署，调用契约锁获取签约页面url接口，渠道端打开url至契约锁中审批
4. PRM提供状态回调接口提供给契约锁，契约锁配置回调接口
5. 渠道端签署完成，契约锁回调PRM状态：已完成
6. 讯飞端，创建人在对账单未签署完成时，可撤回对账单，调用契约锁撤回合同接口
7. 讯飞端，对账单模板预览，调用契约锁模板预览接口
8. 讯飞端、渠道端，在签署完成后，可查看对账单，调用契约锁下载合同接口

> 以上契约锁相关接口，可参考契约锁接口文档、渠道签约模块

### 2.2.3. 维护BGBU

1. 新建BGBU配置表，维护：BGBU编码、BGBU名称、状态（禁用启用）
2. 目前直接在数据库中维护，后期前端做BGBU页面维护功能
2. 包括：工业智能业务部、教育BG、消费者BG、销委会、运营商BU、智慧城市BG、智慧医疗BU、智能服务
3. 具体字段参考BGBU表结构

### 2.2.4. 讯飞端-导入管理-导入与提交

**导入管理**菜单权限：根据业务提供的权限配置文档在uap中配置

#### 2.2.4.1. 模板下载

1. 后端根据原需求Excel导入模板调整好字段格式后，提供给前端放入前端工程
2. 前端提供模板下载功能

#### 2.2.4.2. 导入字段

| 序号 | 字段（列名）         | 字段说明             | 校验                                                         | 备注                                           |
| ---- | -------------------- | -------------------- | ------------------------------------------------------------ | ---------------------------------------------- |
| 1    | 序号                 | 整数，导入Excel自带  | 必填；整数                                                   |                                                |
| 2    | 签约客户             | 文本，渠道商公司名称 | 1. 必填；长度：128<br />2. 渠道商档案表中存在，且是启用状态<br />3. 已完成电子签认证 | 将名称转换为渠道商ID                           |
| 3    | 签约日期             | 文本，日期           | 必填；日期格式，YYYY-MM-DD                                   |                                                |
| 4    | 合同编号             | 文本                 | 必填；长度：30                                               |                                                |
| 5    | 合同名称             | 文本                 | 必填；长度：128                                              |                                                |
| 6    | 合同金额             | 小数，小数点后两位   | 必填；DECIMAL(16,2)                                          | 单位：元                                       |
| 7    | 我司已收款金额（元） | 小数，小数点后两位   | 必填；DECIMAL(16,2)                                          |                                                |
| 8    | 我司未收款金额（元） | 小数，小数点后两位   | 必填；DECIMAL(16,2)                                          |                                                |
| 9    | 其中应收款金额（元） | 小数，小数点后两位   | 必填；DECIMAL(16,2)                                          |                                                |
| 10   | 开票金额（元）       | 小数，小数点后两位   | 若对账模板是**对账模板-有开票金额**，则必填，且是DECIMAL(16,2) |                                                |
| 11   | 签约主体             | 文本，甲方公司名称   | 1. 必填；长度：128<br />2. 甲方基本信息表中存在，且是启用状态<br />3. 可进行电子签章 | 1. 将名称转换为甲方公司ID<br />2. 放入redis    |
| 12   | 客户经理             | 文本，姓名-域账号    | 1. 必填；长度：50<br />2. 域账号是否存在。先校验讯飞用户表是否存在，若不存在再调用PS接口。此处可使用公共的获取用户方法，已包含上述逻辑 | 后期考虑讯飞用户定时任务全量同步，域账号、姓名 |
| 13   | BGBU                 | 文本，BGBU名称       | 1. 必填；长度：128<br />2. BGBU表中存在，且是启用状态        | 1. 将名称转换为BGBU编码<br />2. 放入redis      |
| 14   | 所属区域             | 文本，大区名称       | 1. 必填；长度：100<br />2. 大区表中存在，且是启用状态        | 放入redis                                      |
| 15   | 所属省份             | 文本                 | 1. 必填；长度：255<br />2. 省市区表中存在，且是启用状态      | 放入redis                                      |
| 16   | 项目编号             | 文本                 | 必填：长度：50                                               |                                                |
| 17   | 项目名称             | 文本                 | 必填；长度：128                                              |                                                |
| 18   | 对账函模板编号       | 整数，模板类型       | 必填；必须是0或1                                             | 0：对账模板-无开票金额1：对账模板-有开票金额   |
| 19   | 数据截止日期         | 文本，日期           | 必填；日期格式，YYYY-MM-DD                                   |                                                |

#### 2.2.4.2. 导入

后端导入日志controller批量导入接口关键逻辑：

1. 先校验，查询往来对账导入表，判断当前登录人是否有未完成的导入，若有，前端提示：“请等待上次导入完成后再操作！”，终止；若无，异步调用导入日志service的导入方法，前端提示：“对账单导入中，请耐心等待，导入情况可进入日志中查看”，继续进行以下逻辑
2. 生成导入日志序列号（生成规则：WLDZDR+YYYY-MM-DD+**5位流水号**），存入导入日志主表，状态：导入中；创建时间：当前时间
3. 批量保存原始数据进入导入日志明细表
4. 定义变量：校验结果，遍历导入列表，校验、编码转换
   1. 使用java8并行流遍历导入列表，进行校验，校验失败日志放入失败原因字段中
   2. 具体字段校验、编码转换逻辑参考 [2.2.4.2. 导入字段](#2.2.4.2. 导入字段)
   3. 校验所有行，先进行必填、格式、数据类型等初步校验，然后再进行数据校验（是否存在、状态等），初步校验不通过不进行数据校验
   4. 每一行校验失败日志拼接到每一行的失败原因字段中
   5. 最后所
5. 判断校验结果，true：
   1. 更新导入主表状态：导入成功，及其它更新相关3个字段
   2. 分组、保存往来对账信息：
      1. 根据甲乙方编码分组
         1. 使用java8流分组
         2. **注：**对比串行流串行分组（stream、groupingBy）和并行流并发分组（parallelStream、groupingByConcurrent）的效率，然后再选择
      2. 遍历分组结果，组装数据：
         1. 创建往来对账主表po，预生成主表UUID，存入明细表po list中
         2. 批量生成对账单编号（生成规则：WLDZ+YYYY-MM-DD+5位流水号），注意需使用**分布式锁**，保证对账单编号不冲突
         3. 计算应收款合计（小写），并转换成大写
         4. 设置往来对账主表po状态：暂存
         4. 设置往来对账主表po创建、更新等相关字段
      3. 批量插入对账单明细表，**具体字段参考表结构设计**
      4. 批量插入对账单主表
         1. **具体字段参考表结构设计**
         3. **注：**操作人、操作时间不需单独建字段，使用创建人域账号、创建人姓名、创建时间
6. 判断校验结果，false：
   1. 批量更新导入日志明细表失败原因
   2. 导出失败日志Excel，包含：原始数据、失败原因
   3. 导出失败日志Excel上传至文件服务器，并保存至附件表中，关联导入日志主表ID
   4. 更新导入主表状态：导入失败，及其它更新相关3个字段

#### 2.2.4.4. 分页列表

1. 数据权限：

   1. 当前登录人仅可查看自己导入的数据
   2. 对账状态：暂存

2. 查询条件：

   | 序号 | 字段         | 类型       | 备注                                                         |
   | ---- | ------------ | ---------- | ------------------------------------------------------------ |
   | 1    | 对账单编号   | 文本       | 精确查询                                                     |
   | 2    | 签约客户名称 | 文本       | 1. 前端字段名：签约客户<br />2. 渠道商公司名称<br />3. 模糊查询 |
   | 3    | 签约主体名称 | 文本       | 1.前端字段名：签约主体<br />2. 甲方公司名称<br />3. 模糊查询 |
   | 4    | BGBU编码     | 下拉框     | 1. 前端字段名：BGBU<br />2. 后端提供接口，取所有状态的BGBU列表<br />3. 精确查询 |
   | 5    | 所属区域编码 | 下拉框     | 1. 前端字段名：所属区域<br />2. 公共接口，取所有状态的大区列表<br />3. 精确查询 |
   | 6    | 所属省份编码 | 下拉框     | 1. 前端字段名：所属省份<br />2. 后端提供接口，取所有状态的省份<br />3. 精确查询 |
   | 7    | 数据截止日期 | 日期选择框 | YYYY-MM-DD；精确查询                                         |
   | 8    | 操作人姓名   | 文本       | 1. 前端字段名：操作人<br />2. 模糊查询                       |
   | 9    | 操作时间     | 日期选择框 | YYYY-MM-DD；精确查询                                         |

3. 排序：更新时间倒序

4. 分页参数：20、50、100

5. 分页列表接口返回字段：

   | 序号 | 字段         | 是否展示 | 备注                                                         |
   | ---- | ------------ | -------- | ------------------------------------------------------------ |
   | 1    | ID           | 否       |                                                              |
   | 2    | 对账单编号   | 是       |                                                              |
   | 3    | 签约客户ID   | 否       |                                                              |
   | 4    | 签约客户名称 | 是       | 1. 前端列名：签约客户<br />2. 关联渠道商档案表查询           |
   | 5    | 签约主体ID   | 否       |                                                              |
   | 6    | 签约主体名称 | 是       | 1. 前端列名：签约主体<br />2. 关联甲方基本信息表查询         |
   | 7    | BGBU编码     | 否       |                                                              |
   | 8    | BGBU名称     | 是       | 1. 前端列名：BGBU<br />2. 关联BGBU表查询                     |
   | 9    | 所属区域编码 | 否       |                                                              |
   | 10   | 所属区域名称 | 是       | 1. 前端列名：所属区域<br />2. 关联大区表查询                 |
   | 11   | 所属省份编码 | 否       |                                                              |
   | 12   | 所属省份名称 | 是       | 1. 前端列名：所属省份<br />2. 关联省市区表查询，level：2（省） |
   | 13   | 数据截止日期 | 是       | YYYY-MM-DD                                                   |
   | 14   | 创建人域账号 | 否       |                                                              |
   | 15   | 创建人姓名   | 否       |                                                              |
   | 16   | 创建人       | 是       | 后端sql拼接：创建人姓名[创建人域账号]                        |
   | 16   | 操作时间     | 是       | YYYY-MM-DD HH:MM:SS                                          |
   | 17   | 提交失败原因 | 是       | 1. 前端展示按钮：查看<br />2. 只有当提交失败原因非空时才展示查看按钮<br />3. 点击查看弹框展示提交失败原因 |

#### 2.2.4.5. 导出

1. 菜单权限：根据业务提供的权限配置文档在uap中配置

2. 数据权限、查询条件同分页列表

3. 不分页

4. 列表查询接口，查询往来对账主表，关联往来对账明细表，返回**往来对账-导入与提交ExcelDTO**：

   | 序号 | 字段                 | 是否导出 | 备注                                                  |
   | ---- | -------------------- | -------- | ----------------------------------------------------- |
   | 1    | ID                   | 否       |                                                       |
   | 2    | 对账单编号           | 是       |                                                       |
   | 3    | 签约客户ID           | 否       |                                                       |
   | 4    | 签约客户名称         | 是       | 1. Excel列名：签约客户<br />2. 关联渠道商档案表查询   |
   | 5    | 签约日期             | 是       | YYYY-MM-DD                                            |
   | 6    | 合同编号             | 是       |                                                       |
   | 7    | 合同名称             | 是       |                                                       |
   | 8    | 合同金额             | 是       |                                                       |
   | 9    | 我司已收款金额（元） | 是       |                                                       |
   | 10   | 我司未收款金额（元） | 是       |                                                       |
   | 11   | 其中应收款金额（元） | 是       |                                                       |
   | 12   | 开票金额（元）       | 是       |                                                       |
   | 13   | 签约主体ID           | 否       |                                                       |
   | 14   | 签约主体名称         | 是       | 1. Excel列名：签约主体<br />2. 关联甲方基本信息表查询 |
   | 15   | 客户经理域账号       | 否       |                                                       |
   | 16   | 客户经理姓名         | 否       | 关联讯飞用户表查询                                    |
   | 17   | 客户经理             | 是       | 后端sql拼接：客户经理域账号[客户经理姓名]             |
   | 18   | BGBU编码             | 否       |                                                       |
   | 19   | BGBU名称             | 是       | 1. Excel列名：BGBU<br />2. 关联BGBU表查询             |
   | 20   | 所属区域编码         | 否       |                                                       |
   | 21   | 所属区域名称         | 是       | 1. Excel列名：所属区域<br />2. 关联大区表查询         |
   | 22   | 所属省份编码         | 否       |                                                       |
   | 23   | 所属省份名称         | 是       | 1. Excel列名：所属省份<br />2. 关联省市区表查询       |
   | 24   | 项目编号             | 是       |                                                       |
   | 25   | 项目名称             | 是       |                                                       |
   | 26   | 对账函模板编号       | 是       | 0；1                                                  |
   | 27   | 数据截止日期         | 是       | YYYY-MM-DD                                            |
   | 28   | 创建人域账号         | 否       |                                                       |
   | 29   | 创建人姓名           | 否       |                                                       |
   | 30   | 创建人               | 是       | 后端sql拼接：创建人域账号[创建人姓名]                 |
   | 29   | 创建时间             | 是       | 1. Excel列名：操作时间<br />2. YYYY-MM-DD HH:MM:SS    |

#### 2.2.4.6. 查看详情

后端提供查询接口，查询往来对账主表，关联往来对账明细表，返回往来对账DTO：

| 序号 | 字段               | 是否展示 | 备注                                                         |
| ---- | ------------------ | -------- | ------------------------------------------------------------ |
| 1    | ID                 | 否       |                                                              |
| 2    | 对账单编号         | 是       |                                                              |
| 3    | 签约客户ID         | 否       |                                                              |
| 4    | 签约客户名称       | 是       | 1. 前端字段名：签约客户<br />2. 关联渠道商档案表查询         |
| 5    | 签约主体ID         | 否       |                                                              |
| 6    | 签约主体名称       | 是       | 1. 前端字段名：签约主体<br />2. 关联甲方基本信息表查询       |
| 7    | BGBU编码           | 否       |                                                              |
| 8    | BGBU名称           | 是       | 1.前端字段名：BGBU<br />2. 关联BGBU表查询                    |
| 9    | 所属区域编码       | 否       |                                                              |
| 10   | 所属区域名称       | 是       | 1. 前端字段名：所属区域<br />2. 关联大区表查询               |
| 11   | 所属省份编码       | 否       |                                                              |
| 12   | 所属省份名称       | 是       | 1. 前端字段名：所属省份<br />2. 关联省市区表查询             |
| 13   | 对账函模板编号     | 是       | 1. 前端字段名：对账函模板<br />2. 后端返回0、1，前端自己翻译，0：对账模板-无开票金额；1：对账模板-有开票金额 |
| 14   | 数据截止日期       | 是       | YYYY-MM-DD                                                   |
| 15   | 应收款合计（小写） | 是       |                                                              |
| 16   | 应收款合计（大写） | 是       |                                                              |
| 17   | 往来对账明细表DTO  | 是       | 参考下方段说明                                               |

往来对账明细表DTO字段说明：

| 序号 | 字段                 | 是否导出 | 备注                                      |
| ---- | -------------------- | -------- | ----------------------------------------- |
| 1    | ID                   | 否       |                                           |
| 2    | 签约主表ID           | 否       |                                           |
| 3    | 合同编号             | 是       |                                           |
| 4    | 合同名称             | 是       |                                           |
| 5    | 签约日期             | 是       | YYYY-MM-DD                                |
| 6    | 合同金额             | 是       |                                           |
| 7    | 我司已收款金额（元） | 是       |                                           |
| 8    | 我司未收款金额（元） | 是       |                                           |
| 9    | 其中应收款金额（元） | 是       |                                           |
| 10   | 开票金额（元）       | 是       |                                           |
| 11   | 客户经理域账号       | 否       |                                           |
| 12   | 客户经理姓名         | 否       | 关联讯飞用户表查询                        |
| 13   | 客户经理             | 是       | 后端sql拼接：客户经理域账号[客户经理姓名] |
| 14   | 项目编号             | 是       |                                           |
| 15   | 项目名称             | 是       |                                           |

#### 2.2.4.7. 删除

后端提供根据ID删除往来对账接口：

1.  **参数：ID**
2.  校验ID必填
3.  根据ID获取往来对账主表数据（不同于查询详情接口，只需调用Mybatis Plus getById方法即可）
4.  判断是否存在
    1.  不存在，直接返回，提示”操作失败，查询不到数据！“
    2.  若存在，继续执行以下逻辑
5.  判断当前审批状态是否是**暂存**：
    1.  否，直接返回，提示"当前数据已更改，不可操作！"
    2.  是，继续执行以下逻辑
6.  删除往来对账明细表
7.  删除往来对账主表

#### 2.2.4.8. 提交（第一次提交）

后端提供根据ID创建往来对账审批流程接口：

1. **参数：往来对账ID**

2. 根据ID获取往来对账详情DTO

3. 判断是否存在
   1.  不存在，直接返回，提示”操作失败，查询不到数据！“
   2.  若存在，继续执行以下逻辑
   
4. 判断当前审批状态是否是**暂存**：
   1.  否，直接返回，提示"当前数据已更改，不可操作！"
   2.  是，继续执行以下逻辑
   
5. 判断instanceId是否为空：
   1. 非空，直接返回，提示“流程已提交，请勿重复提交！”
   2. 空，继续执行以下逻辑

6. 查询区域负责人：
   1. 根据所属区域编码，查询流程审批人角色映射表获得对应的区域负责人角色编码
   2. 根据负责人角色编码，调用uap通过角色编码获取人员接口，获得对应的负责人
   3. 将负责人保存到当前审批人字段：姓名[域账号]，多个审批人以英文逗号拼接
   
7. 包装相应参数，调用流程引擎创建流程接口，返回流程实例ID，将其保存到instanceId字段

   > 将对账单编号传到流程引擎

8. 设置当前节点：区域负责人节点

9. 设置提交相关字段
   1. 提交人域账号：当前登录人域账号，LoginUser中获取
   2. 提交时间：当前时间，new Date()
   3. 对账状态：审批中
   
10. 设置更新相关3个字段

11. 保存往来对账主表数据

#### 2.2.4.9. 批量提交

1. 获取当前登录人上次批量提交结果

   1. 参数：无
   2. 后端从redis中获取当前登陆人上次批量提交结果：是否完成标识、总数、成功数、失败数、耗时
   3. redis key：wldz:pldr:域账号

2. 批量提交接口，参数：选中的往来对账ID列表

   1. 先校验，从redis中获取当前登陆人上次批量提交结果，若未完成，前端提示：“请等待上次批量提交完成后再操作！”，终止；

      若为空或已完成，异步调用往来对账service的批量提交方法，前端提示：”对账单提交中，请耐心等待“，继续进行以下逻辑

   2. 设置当前登陆人上次批量提交结果标识：提交中，放入redis

   3. 根据选中的往来对账ID列表，查询往来对账详细信息

   4. 遍历往来对账单据列表

      1. 根据所属区域编码查询区域负责人
   
      2. 包装相关参数，调用流程引擎创建流程接口，返回restResponse，判断result
   
         > 将对账单编号传到流程引擎
   
      3. true
         1. 设置intanceId、流程相关信息、对账状态Z（审批中）等字段
         2. 成功条数+1
         
      4. false
         1. 将返回msg放入往来对账提交失败原因字段中
         2. 失败条数+1

      > * 使用java8并行流遍历所有列表，调用创建流程接口，无论成功与否。若失败，将返回msg放入往来对账-失败原因字段中；若成功，则设置instanceId、流程相关信息、对账状态等字段
      > * 计数：总数，成功、失败条数
      > * 计算耗时
      > * 创建流程， 参考单次提交业务逻辑
   
   5. 批量保存往来对账主表数据
   
   6. 将本次批量提交结果放入redis：结果标识：已完成、总数、成功数、失败数、耗时

### 2.2.5. 讯飞端-导入管理-导入日志

1. 数据权限：当前登录人仅可查看自己的导入日志

2. 查询条件：TODO

3. 排序：创建时间倒序

4. 分页参数同其它模块

5. 分页列表接口返回字段：

   | 序号 | 字段         | 是否展示 | 备注                                                         |
   | ---- | ------------ | -------- | ------------------------------------------------------------ |
   | 1    | ID           | 否       |                                                              |
   | 2    | 日志序列号   | 是       |                                                              |
   | 3    | 创建人域账号 | 否       |                                                              |
   | 4    | 创建人姓名   | 否       |                                                              |
   | 5    | 创建人       | 是       | 1. 前端列名：操作人<br />2. 后端sql拼接：创建人姓名[创建人域账号] |
   | 6    | 创建时间     | 是       | 1. 前端列名：操作时间<br />2. YYYY-MM-DD HH:MM:SS            |
   | 7    | 导入状态编码 | 否       |                                                              |
   | 8    | 导入状态名称 | 是       | 1. 前端列名：导入状态<br />2. 关联子字典表查询               |
   | 9    | 日志报告     | 是       | 1. 按钮：预览、下载<br />2. 只有导入失败时才展示按钮<br />3. 关联附件表查询<br />4. 预览、下载接口：公用接口 |

### 2.2.6. 讯飞端-对账管理-分页列表

1. 菜单权限：根据业务提供的权限配置文档在uap中配置

2. 数据权限：根据业务提供的权限配置文档在uap中配置，根据**所属区域**配置数据权限

3. 排序：提交时间倒序

4. 分页参数：20、50、100

5. 隐藏参数：**状态（非暂存）**

6. 查询参数：

   | 序号 | 字段         | 类型       | 备注                                                         |
   | ---- | ------------ | ---------- | ------------------------------------------------------------ |
   | 1    | 对账单编号   | 文本       | 精确查询                                                     |
   | 2    | 签约客户名称 | 文本       | 1. 前端字段名：签约客户<br />2. 渠道商公司名称<br />3. 模糊查询 |
   | 3    | 签约主体名称 | 文本       | 1.前端字段名：签约主体<br />2. 甲方公司名称<br />3. 模糊查询 |
   | 4    | BGBU编码     | 下拉框     | 1. 前端字段名：BGBU<br />2. 后端提供接口，取所有状态的BGBU列表<br />3. 精确查询 |
   | 5    | 所属区域编码 | 下拉框     | 1. 前端字段名：所属区域<br />2. 公共接口，取所有状态的大区列表<br />3. 精确查询 |
   | 6    | 所属省份编码 | 下拉框     | 1. 前端字段名：所属省份<br />2. 后端提供接口，取所有状态的省份<br />3. 精确查询 |
   | 7    | 数据截止日期 | 日期选择框 | YYYY-MM-DD；精确查询                                         |
   | 8    | 对账状态编码 | 下拉框     | 1. 前端字段名：对账状态<br />2. 公共接口，获取子字典<br />3. 精确查询<br />4. 隐藏**暂存**选项 |

7. 分页列表接口返回字段：

   | 序号 | 字段         | 是否展示 | 备注                                                         |
   | ---- | ------------ | -------- | ------------------------------------------------------------ |
   | 1    | ID           | 否       |                                                              |
   | 2    | 对账单编号   | 是       |                                                              |
   | 3    | 签约客户ID   | 否       |                                                              |
   | 4    | 签约客户名称 | 是       | 1. 前端列名：签约客户<br />2. 关联渠道商档案表查询           |
   | 5    | 签约主体ID   | 否       |                                                              |
   | 6    | 签约主体名称 | 是       | 1. 前端列名：签约主体<br />2. 关联甲方基本信息表查询         |
   | 7    | BGBU编码     | 否       |                                                              |
   | 8    | BGBU名称     | 是       | 1. 前端列名：BGBU<br />2. 关联BGBU表查询                     |
   | 9    | 所属区域编码 | 否       |                                                              |
   | 10   | 所属区域名称 | 是       | 1. 前端列名：所属区域<br />2. 关联大区表查询                 |
   | 11   | 所属省份编码 | 否       |                                                              |
   | 12   | 所属省份名称 | 是       | 1. 前端列名：所属省份<br />2. 关联省市区表查询，level：2（省） |
   | 13   | 数据截止日期 | 是       | YYYY-MM-DD                                                   |
   | 14   | 提交人域账号 | 否       |                                                              |
   | 15   | 提交人姓名   | 否       | 关联讯飞用户表查询                                           |
   | 16   | 提交人       | 是       | 后端sql拼接：提交人姓名[提交人域账号]                        |
   | 17   | 当前审批人   | 是       | 姓名[域账号]，多个以英文逗号连接                             |
   | 18   | 对账状态编码 | 否       |                                                              |
   | 19   | 对账状态名称 | 是       | 1. 前端列名：对账状态<br />2. 关联子字典表查询               |
   | 20   | instanceId   | 否       | 用于前端点击查看详情调用获取审批记录接口                     |

8. 列表操作按钮：渠道是否展示

   1. 只针对**已撤回**的对账单，选择是或否
   2. 按钮打开渠道端展示，按钮关闭渠道端不展示
   2. 后端提供接口，根据前端参数修改渠道是否展示字段，0：否；1：是

### 2.2.7. 讯飞端-对账管理-导出

1. 菜单权限：根据业务提供的权限配置文档在uap中配置

2. 数据权限、查询条件同分页列表

3. 不分页

4. 列表查询接口：

   1. 接口一：第一个sheet页，查询往来对账主表，关联往来对账明细表，返回**往来对账-对账管理ExcelDTO**：

      | 序号 | 字段                 | 是否导出 | 备注                                                  |
      | ---- | -------------------- | -------- | ----------------------------------------------------- |
      | 1    | ID                   | 否       |                                                       |
      | 2    | 对账单编号           | 是       |                                                       |
      | 3    | 签约客户ID           | 否       |                                                       |
      | 4    | 签约客户名称         | 是       | 1. Excel列名：签约客户<br />2. 关联渠道商档案表查询   |
      | 5    | 签约日期             | 是       | YYYY-MM-DD                                            |
      | 6    | 合同编号             | 是       |                                                       |
      | 7    | 合同名称             | 是       |                                                       |
      | 8    | 合同金额             | 是       |                                                       |
      | 9    | 我司已收款金额（元） | 是       |                                                       |
      | 10   | 我司未收款金额（元） | 是       |                                                       |
      | 11   | 其中应收款金额（元） | 是       |                                                       |
      | 12   | 开票金额（元）       | 是       |                                                       |
      | 13   | 签约主体ID           | 否       |                                                       |
      | 14   | 签约主体名称         | 是       | 1. Excel列名：签约主体<br />2. 关联甲方基本信息表查询 |
      | 15   | 客户经理域账号       | 否       |                                                       |
      | 16   | 客户经理姓名         | 否       | 关联讯飞用户表查询                                    |
      | 17   | 客户经理             | 是       | 后端sql拼接：客户经理域账号[客户经理姓名]             |
      | 18   | BGBU编码             | 否       |                                                       |
      | 19   | BGBU名称             | 是       | 1. Excel列名：BGBU<br />2. 关联BGBU表查询             |
      | 20   | 所属区域编码         | 否       |                                                       |
      | 21   | 所属区域名称         | 是       | 1. Excel列名：所属区域<br />2. 关联大区表查询         |
      | 22   | 所属省份编码         | 否       |                                                       |
      | 23   | 所属省份名称         | 是       | 1. Excel列名：所属省份<br />2. 关联省市区表查询       |
      | 24   | 项目编号             | 是       |                                                       |
      | 25   | 项目名称             | 是       |                                                       |
      | 26   | 对账函模板编号       | 是       | 0；1                                                  |
      | 27   | 数据截止日期         | 是       | YYYY-MM-DD                                            |
      | 28   | 提交人域账号         | 否       |                                                       |
      | 29   | 提交人姓名           | 否       | 关联讯飞用户表查询                                    |
      | 30   | 提交人               | 是       | 后端sql拼接：提交人姓名[提交人域账号]                 |
      | 31   | 提交时间             | 是       | 1. Excel列名：提交时间<br />2. YYYY-MM-DD             |
      | 32   | 对账状态编码         | 否       |                                                       |
      | 33   | 对账状态名称         | 是       | 1. Excel列名：对账状态<br />2. 关联子字典表查询       |
      | 34   | 当前审批人           | 是       | 姓名[域账号]，多个以英文逗号连接                      |
      | 35   | 渠道是否展示         | 是       | 后端存0、1，查询后通过EasyExcel公共转换器转成是/否    |

   2. 接口二：第二个sheet页，查询往来对账主表，关联往来对账反馈记录表，返回**往来对账-反馈记录ExcelDTO**：
   
      | 序号 | 字段         | 是否导出 | 备注              |
      | ---- | ------------ | -------- | ----------------- |
      | 1    | 对账单编号   | 是       |                   |
      | 2    | 反馈人ID     | 否       |                   |
      | 3    | 反馈人姓名   | 是       | Excel列名：反馈人 |
      | 4    | 反馈人手机号 | 是       |                   |
      | 5    | 反馈时间     | 是       |                   |
      | 6    | 反馈意见     | 是       |                   |

### 2.2.8. 讯飞端-对账管理-详情页

#### 2.2.8.1. 查询详情

1. 根据ID查询往来对账详情接口，查询往来对账主表，关联往来对账明细表，返回往来对账DTO：

   | 序号 | 字段               | 是否展示 | 备注                                                         |
   | ---- | ------------------ | -------- | ------------------------------------------------------------ |
   | 1    | ID                 | 否       |                                                              |
   | 2    | 对账单编号         | 是       |                                                              |
   | 3    | 签约客户ID         | 否       |                                                              |
   | 4    | 签约客户名称       | 是       | 1. 前端字段名：签约客户<br />2. 关联渠道商档案表查询         |
   | 5    | 签约主体ID         | 否       |                                                              |
   | 6    | 签约主体名称       | 是       | 1. 前端字段名：签约主体<br />2. 关联甲方基本信息表查询       |
   | 7    | BGBU编码           | 否       |                                                              |
   | 8    | BGBU名称           | 是       | 1.前端字段名：BGBU<br />2. 关联BGBU表查询                    |
   | 9    | 所属区域编码       | 否       |                                                              |
   | 10   | 所属区域名称       | 是       | 1. 前端字段名：所属区域<br />2. 关联大区表查询               |
   | 11   | 所属省份编码       | 否       |                                                              |
   | 12   | 所属省份名称       | 是       | 1. 前端字段名：所属省份<br />2. 关联省市区表查询             |
   | 13   | 对账函模板编号     | 是       | 1. 前端字段名：对账函模板<br />2. 后端返回0、1，前端自己翻译，0：对账模板-无开票金额；1：对账模板-有开票金额<br />3. 用于判断是否显示开票金额 |
   | 14   | 数据截止日期       | 是       | YYYY-MM-DD                                                   |
   | 15   | 应收款合计（小写） | 是       |                                                              |
   | 16   | 应收款合计（大写） | 是       |                                                              |
   | 17   | 渠道是否展示       | 是       | 后端返回0、1，前端自己翻译，0：否；1：是                     |
   | 18   | 提交人域账号       | 否       |                                                              |
   | 19   | 提交人姓名         | 否       | 关联讯飞用户表查询                                           |
   | 20   | 提交人             | 是       | 后端sql拼接：提交人姓名[提交人域账号]                        |
   | 21   | 当前审批人         | 是       | 姓名[域账号]，多个以英文逗号连接                             |
   | 22   | 对账状态编码       | 否       |                                                              |
   | 23   | 对账状态名称       | 是       | 1. 前端列名：对账状态<br />2. 关联子字典表查询               |
   | 24   | taskId             | 否       | 用于调用流程引擎相关接口                                     |
   | 25   | instanceId         | 否       | 用于调用流程引擎相关接口                                     |
   | 26   | 往来对账明细表DTO  | 是       | 参考下方段说明                                               |
   
   往来对账明细表DTO字段说明：
   
   | 序号 | 字段                 | 是否展示 | 备注                                      |
   | ---- | -------------------- | -------- | ----------------------------------------- |
   | 1    | ID                   | 否       |                                           |
   | 2    | 签约主表ID           | 否       |                                           |
   | 3    | 合同编号             | 是       |                                           |
   | 4    | 合同名称             | 是       |                                           |
   | 5    | 签约日期             | 是       | YYYY-MM-DD                                |
   | 6    | 合同金额             | 是       |                                           |
   | 7    | 我司已收款金额（元） | 是       |                                           |
   | 8    | 我司未收款金额（元） | 是       |                                           |
   | 9    | 其中应收款金额（元） | 是       |                                           |
   | 10   | 开票金额（元）       | 是       | **根据对账函模板是否有开票金额展示该列**  |
   | 11   | 客户经理域账号       | 否       |                                           |
   | 12   | 客户经理姓名         | 否       | 关联讯飞用户表查询                        |
   | 13   | 客户经理             | 是       | 后端sql拼接：客户经理域账号[客户经理姓名] |
   | 13   | 项目编号             | 是       |                                           |
   | 14   | 项目名称             | 是       |                                           |
   
2. 根据往来对账ID查询反馈记录接口，返回反馈记录DTO List

   1. 往来对账反馈记录表左关联附件表，最终得到反馈记录DTO List，其中包括附件DTO List

   2. 查询条件：往来对账ID

   3. 排序：反馈时间升序

   4. 反馈记录DTO：

      | 序号 | 字段         | 是否展示 | 备注                                                         |
      | ---- | ------------ | -------- | ------------------------------------------------------------ |
      | 1    | ID           | 否       |                                                              |
      | 2    | 反馈人账号   | 否       | 渠道商用户ID或讯飞用户域账号                                 |
      | 3    | 反馈人姓名   | 否       |                                                              |
      | 4    | 反馈人       | 是       | 1. 渠道端字段名：反馈人<br />2. 讯飞端字段名：答复人<br />3. 后端sql拼接：反馈人姓名[反馈人域账号] |
      | 5    | 反馈人手机号 | 是       | 只有渠道端用户才有                                           |
      | 6    | 反馈时间     | 是       | 1. 渠道端字段名：反馈时间<br />2. 讯飞端字段名：答复时间<br />3. 格式：YYYY-MM-DD HH:MM:SS |
      | 7    | 反馈意见     | 是       | 1. 渠道端字段名：反馈意见<br />2. 讯飞端字段名：答复内容     |
      | 8    | 附件DTO      | 是       | 通用附件相关信息                                             |

3. 根据instanceId查询流程审批记录接口：公共接口

4. 根据instanceId查询流程图接口：公共接口

#### 2.2.8.2. 关闭

1. 前端判断对账状态为**驳回**时展示按钮
2. 后端提供**关闭接口**：
   1. **参数：ID**
   2. 校验ID必填
   3. 根据ID获取往来对账主表数据（不同于查询详情接口，只需调用Mybatis Plus getById方法即可）
   4. 判断是否存在
      1.  不存在，直接返回，提示”操作失败，查询不到数据！“
      2.  若存在，继续执行以下逻辑
   5. 判断当前对账状态是否是**驳回**：
      1.  否，直接返回，提示"当前数据已更改，不可操作！"
      2.  是，继续执行以下逻辑
   6. 设置对账状态：关闭
   7. 设置更新相关3个字段
   8. 保存往来对账主表数据

#### 2.2.8.3. 提交（驳回后提交）

1. 前端判断对账状态为**驳回**时展示按钮
2. 后端提供**resubmit接口**：
   1. **参数：ID**（因为前端不可编辑，所以后端查询数据提交，免去后端必填、格式校验等）
   2. 校验ID必填
   3. 根据ID获取往来对账详情DTO
   4. 判断是否存在
      1.  不存在，直接返回，提示”操作失败，查询不到数据！“
      2.  若存在，继续执行以下逻辑
   5. 判断当前对账状态是否是**驳回**：
      1.  否，直接返回，提示"当前数据已更改，不可操作！"
      2.  是，继续执行以下逻辑
   6. 查询区域负责人：
      1. 根据往来对账详情DTO中的所属区域编码，查询流程审批人角色映射表获得对应的区域负责人角色编码
      2. 根据负责人角色编码，调用uap通过角色编码获取人员接口，获得对应的负责人
      3. 将负责人保存到当前审批人字段：姓名[域账号]，多个审批人以英文逗号拼接
   7. 包装相应参数，调用流程引擎**提交流程实例**接口
   8. 设置对账状态：审批中
   9. 设置当前节点：区域负责人节点
   10. 设置更新相关3个字段
   11. 保存往来对账主表数据


#### 2.2.8.4. 答复

1. 前端判断对账状态为**待签署（待答复）**时展示按钮

2. 后端提供**答复接口**

   1. 参数：往来对账-反馈DTO

      | 序号 | 字段           | 类型 | 是否必填 | 备注                                                         |
      | ---- | -------------- | ---- | -------- | ------------------------------------------------------------ |
      | 1    | 往来对账主表ID | 整数 | 是       |                                                              |
      | 2    | 反馈意见       | 文本 | 是       | 1. 前端字段名：答复内容<br />2. 长度：2000                   |
      | 3    | 附件DTO        | 附件 | 否       | 1. 通用附件上传相关字段<br />2. 非必填<br />3. 类型：txt,pdf,doc,docx,md,bmp,png,jpg,jpeg,gif,xls,xlsx,ppt,pptx,zip,7z<br />4. 大小：200m<br />5. 限制数量：5 |

   2. 后端做相关必填、格式等校验

   3. 根据往来对账主表ID获取往来对账主表数据（不同于查询详情接口，只需调用Mybatis Plus getById方法即可）

   4. 判断是否存在

      1.  不存在，直接返回，提示”操作失败，查询不到数据！“
      2.  若存在，继续执行以下逻辑

   5. 判断当前对账状态是否是**待签署（待答复）**：

      1.  否，直接返回，提示"当前数据已更改，不可操作！"
      2.  是，继续执行以下逻辑

   6. 设置对账状态：**待签署（已答复）**

   7. 设置更新相关3个字段

   8. 设置反馈记录DTO：

      1. 反馈人账号：当前登陆人域账号
      2. 反馈人姓名：当前登陆人姓名
      3. 反馈时间：当前时间

   9. 保存往来对账业务数据：

      1. 保存答复记录到反馈记录表
      2. 保存答复附件到附件表
      3. 保存往来对账主表数据


#### 2.2.8.5. 撤回

1. 前端判断对账状态为**待签署、待签署（待答复）、待签署（已答复）**时展示按钮
2. 后端提供**撤回接口**：
   1. **参数：ID**
   2. 校验ID必填
   3. 根据ID获取往来对账主表数据（不同于查询详情接口，只需调用Mybatis Plus getById方法即可）
   4. 判断是否存在
      1.  不存在，直接返回，提示”操作失败，查询不到数据！“
      2.  若存在，继续执行以下逻辑
   5. 判断当前对账状态是否是：**待签署、待签署（待答复）、待签署（已答复）**：
      1.  否，直接返回，提示"当前数据已更改，不可操作！"
      2.  是，继续执行以下逻辑
   6. 调用契约锁**1.3.4. 撤回合同**接口（参考契约锁接口文档）
   7. 设置对账状态：已撤回
   8. 设置更新相关3个字段
   9. 保存往来对账主表数据


#### 2.2.8.6. 查看对账函

1. 前端判断对账状态为**已完成**时展示按钮
2. 后端提供**获取契约锁合同浏览页面**接口，返回浏览页面链接，前端调用后直接浏览器打开
   1. 参数：**ID**
   2. 校验ID必填
   3. 根据ID获取往来对账主表数据（不同于查询详情接口，只需调用Mybatis Plus getById方法即可）
   4. 判断是否存在
      1.  不存在，直接返回，提示”操作失败，查询不到数据！“
      2.  若存在，继续执行以下逻辑
   5. 判断当前对账状态是否是：**已完成**：
      1.  否，直接返回，提示"操作失败，当前对账函尚未签署完成！"
      2.  是，继续执行以下逻辑
   6. 根据主表数据中的contractId调用契约锁**1.4.1.2 合同浏览页面**接口，返回浏览页面链接
3. 参考契约锁接口文档、渠道签约模块

#### 2.2.8.7. 下载对账函

1. 前端判断对账状态为**已完成**时展示按钮
2. 后端提供下载对账函接口：
   1. 参数：**ID**
   2. 校验ID必填
   3. 根据ID获取往来对账主表数据（不同于查询详情接口，只需调用Mybatis Plus getById方法即可）
   4. 判断是否存在
      1.  不存在，直接返回，提示”操作失败，查询不到数据！“
      2.  若存在，继续执行以下逻辑
   5. 判断当前对账状态是否是：**已完成**：
      1.  否，直接返回，提示"操作失败，当前对账函尚未签署完成！"
      2.  是，继续执行以下逻辑
   6. 根据主表数据中的contractId调用契约锁**1.4.2.1 下载合同**接口

3. 参考契约锁接口文档、渠道签约模块

### 2.2.9. 讯飞端-审批-区域负责人节点

1. 审批功能位于待办中心中
2. 审批意见：文本，长度：666

#### 2.2.9.1. 同意

1. 审批人填写审批意见（**选填**）

2. 后端提供**提交流程**接口：

   1. 参数：

      | 序号 | 字段     | 类型 | 是否必填 | 备注                                                         |
      | ---- | -------- | ---- | -------- | ------------------------------------------------------------ |
      | 1    | ID       | 整数 | 是       | 1. 往来对账主表ID<br />2. 因为前端不可编辑，所以后端查询数据提交，免去后端必填、格式校验等 |
      | 2    | 审批意见 | 文本 | 否       | 非必填；长度：666                                            |

   2. 校验ID必填

   3. 根据ID获取往来对账详情DTO

   4. 判断是否存在

      1.  不存在，直接返回，提示”操作失败，查询不到数据！“
      2.  若存在，继续执行以下逻辑

   5. 判断当前审批状态是否是**审批中**：

      1.  否，直接返回，提示"当前数据已更改，不可操作！"
      2.  是，继续执行以下逻辑

   6. 包装相关参数，调用流程引擎**提交流程实例**接口

   7. 置空当前审批节点、当前审批人字段

   8. 抄送客户经理：

      1. 拼接明细表客户经理域账号字段，先去重，然后多个以英文逗号拼接
      2. 调用流程引擎传阅任务接口
      3. **注：**抄送失败，后台打印相关日志即可，不影响以下逻辑

   9. 创建对账函：

      1. 根据契约锁配置的对账函模板组装参数，将所有参数传到契约锁，包括教育、非教育模板
      2. **注：将对账单编号传到契约锁中**
      3. 调用契约锁**1.1.4.1 用业务分类创建合同**接口，返回contractId，将其保存到往来对账主表contractId字段中
      4. 参考契约锁接口文档、渠道签约模块

   10. 讯飞端自动签署：

       1. 调用契约锁**1.2.1.1 公司公章签署**接口
       2. 参考契约锁接口文档、渠道签约模块

   11. 设置对账状态：**待签署**

   12. **设置渠道是否展示：1**

   13. 设置**渠道端接收时间**：当前时间，new Date()

   14. 设置更新相关3个字段

   15. 保存往来对账主表数据

#### 2.2.9.2. 不同意

1. 审批人选择不对账原因类型、不对账原因，流程驳回至申请人，调用后端退回流程接口

   | 序号 | 字段           | 类型   | 是否必填 | 备注                                                         |
   | ---- | -------------- | ------ | -------- | ------------------------------------------------------------ |
   | 1    | 不对账原因类型 | 下拉框 | 是       | 1. 数据来源：调用根据业务类型获取子字典接口<br />2. 包括：直销客户、合同关闭、移交法务、渠道压货、欠款冲抵、拒绝对账、作废/变更、已提起诉讼、非区域业务<br />3. 字典项需维护在数据字典设计文档中 |
   | 2    | 不对账原因     | 文本   | 是       | 长度：**660**                                                |

   **前端需将不对账原因类型和不对账原因用句号拼接成一个字段：审批意见，然后传给后端接口，如：直销客户。不需要对账**

2. 后端做相关必填、格式等校验

3. 设置当前审批人字段：取提交人域账号（可前端传过来，也可后端查询）

4. 设置审批状态：驳回

5. 包装相应参数，调用流程引擎退回流程实例接口

6. 设置当前审批节点：申请人节点

7. 调用流程引擎根据流程实例id获取当前的流程Taskid，并保存到taskId字段，因为退回到申请节点时，创建人可在分页列表（非待办中心）点击详情后重新提交流程

8. 设置更新相关3个字段

9. 保存主表数据到往来对账主表

#### 2.2.9.3. 加签

前端选择加签人，填写加签意见，然后调用后端流程加签接口：

1. 参数说明：

   | 序号 | 字段     | 类型   | 是否必填 | 备注                                                         |
   | ---- | -------- | ------ | -------- | ------------------------------------------------------------ |
   | 1    | 加签人   | 搜索框 | 是       | 1. 数据来源：调用查询人员接口-公共接口<br />2. 必填<br />3. 多选，前端传加签人域账号，多个以英文逗号拼接 |
   | 2    | 加签意见 | 文本   | 是       | 长度：**666**                                                |

2. 后端做相关必填、格式等校验

3. 当前审批节点、对账状态不变

4. 包装相应参数，调用流程引擎转办任务接口

5. 调用流程引擎获取当前审批人列表接口，更新当前审批节点、当前审批人字段。**参考`WorkFlowServiceImpl#getProcessDoingUserList`**

6. 设置更新相关3个字段

7. 保存主表数据到往来对账主表

#### 2.2.9.4. 转办

前端选择转办人，然后调用后端转办流程接口：

1. 后端做相关必填、格式等校验
   1. 转办人必填，单选，前端转办人传：域账号
   2. 转办意见，文本，必填，长度：666
2. 当前审批节点、对账状态不变
3. 包装相应参数，调用流程引擎转办任务接口
4. 调用流程引擎获取当前审批人列表接口，更新当前审批节点、当前审批人字段。**参考`WorkFlowServiceImpl#getProcessDoingUserList`**
5. 设置更新相关3个字段
6. 保存主表数据到往来对账主表

#### 2.2.9.5. 抄送

前端选择抄送人，然后调用后端**传阅任务**接口：

1. 后端做相关必填、格式等校验（**抄送人必填，多选，前端抄送人传：域账号，多个以英文逗号拼接**）
2. 包装相应参数，调用流程引擎**传阅任务**接口

### 2.2.10. 讯飞端-审批-抄送

1. PRM系统中的待办中心-待阅中会显示当前登录人待阅列表
2. 统一待办中待阅列表和待办列表在一起
3. 前端通过待办/待阅链接URL中的**flowStatus=UnRead**标识，判断当前单据是否是待阅
   1. 是，**前端只展示已阅按钮**
   2. 否，前端展示其它办理按钮（同意、不同意等）
4. 点击已阅按钮，包装相应参数，调用流程引擎**阅毕任务**接口

### 2.2.11. 契约锁回调

1. 回调场景：

   1. 渠道商在契约锁签署对账函完成后
   2. 对账函超期

2. 契约锁回调PRM接口，将对账状态改为：已完成、超期已失效

3. 后端提供契约锁回调接口，并提供给契约锁配置

   1. 参数：

      | 序号 | 字段       | 类型   | 是否必填 | 备注                                             |
      | ---- | ---------- | ------ | -------- | ------------------------------------------------ |
      | 1    | contractId | 字符串 | 是       | 合同ID                                           |
      | 2    | status     | 字符串 | 是       | COMPLETE: 完成；SIGNING: 签署中；EXPIRED: 已过期 |

   2. 校验contractId、status必填

   3. 根据contractId获取往来对账主表数据

   4. 判断是否存在：

      1.  不存在，直接返回，提示”操作失败，查询不到数据！“
      2.  若存在，继续执行以下逻辑

   5. 判断当前对账状态是否是：**待签署、待签署（待答复）、待签署（已答复）**：

      1.  否，直接返回，提示"当前数据已更改，不可操作！"
      2.  是，继续执行以下逻辑

   6. 设置对账状态：已完成/超期已失效

   7. 设置更新相关3个字段:

      1. 更新人账号：qys
      2. 更新人姓名：契约锁
      3. 更新时间：当前时间，new Date()

    8. 保存往来对账主表数据

### 2.2.12. i讯飞待办

1. 后端单独提供i讯飞接口
2. 驳回至申请节点不可操作，参考渠道签约。其它节点**审批**功能同PC端
3. 相关接口：
   1. 查询往来对账详情接口（**不需提供获取反馈记录接口，审批中无反馈记录**）
   2. 查询审批记录：公共接口
   3. 提交
   4. 退回
   5. 转办
   6. 加签
   7. 抄送（传阅）
   8. 阅毕（参考：[PC端阅毕](#2.2.10. 讯飞端-审批-抄送)）

### 2.2.13. 渠道端-应用管理

![image-20211126010008615](https://gitee.com/rocky946/pictures/raw/master/img/image-20211126010008615.png)

菜单权限：在讯飞端-内容管理-应用管理中新建应用，根据业务需求配置权限，应用图标待提供

### 2.2.14. 渠道端-分页列表

1. 数据权限：当前登录人所属渠道商的往来对账数据

2. 排序：**渠道端接收时间**倒序

3. 分页参数：20、50、100

4. **隐藏参数：**

   1. 对账状态：待签署、待签署（待答复）、待签署（已答复）、已完成、已撤回、超期已失效
   2. 渠道是否展示：1

5. 查询参数：

   | 序号 | 字段         | 类型       | 备注                                                         |
   | ---- | ------------ | ---------- | ------------------------------------------------------------ |
   | 1    | 对账单编号   | 文本       | 精确查询                                                     |
   | 2    | 签约主体名称 | 文本       | 1.前端字段名：签约主体<br />2. 甲方公司名称<br />3. 模糊查询 |
   | 3    | 数据截止日期 | 日期选择框 | YYYY-MM-DD；精确查询                                         |
   | 4    | 对账状态编码 | 下拉框     | 1. 前端字段名：对账状态<br />2. 精确查询<br />3. 下拉框选项前端暂时写死，后期在字典表中配置，与讯飞端分开<br />4. 待签署、待签署（待答复）、待签署（已答复）、已完成、已撤回、超期已失效 |

6. 分页列表接口返回字段：

   | 序号 | 字段           | 是否展示 | 备注                                                 |
   | ---- | -------------- | -------- | ---------------------------------------------------- |
   | 1    | ID             | 否       |                                                      |
   | 2    | 对账单编号     | 是       |                                                      |
   | 3    | 签约客户ID     | 否       |                                                      |
   | 4    | 签约客户名称   | 是       | 1. 前端列名：签约客户<br />2. 关联渠道商档案表查询   |
   | 5    | 签约主体ID     | 否       |                                                      |
   | 6    | 签约主体名称   | 是       | 1. 前端列名：签约主体<br />2. 关联甲方基本信息表查询 |
   | 13   | 数据截止日期   | 是       | YYYY-MM-DD                                           |
   | 17   | 对账状态编码   | 否       |                                                      |
   | 18   | 对账状态名称   | 是       | 1. 前端列名：对账状态<br />2. 关联子字典表查询       |
   | 19   | 渠道端接收时间 | 是       | 1. 前端列名：接收时间<br />2. YYYY-MM-DD HH:MM:SS    |

### 2.2.15. 渠道端-详情页

#### 2.2.15.1. 查询详情

1. 根据ID查询往来对账详情接口，查询往来对账主表，关联往来对账明细表，返回往来对账DTO：

   | 序号 | 字段               | 是否展示 | 备注                                                   |
   | ---- | ------------------ | -------- | ------------------------------------------------------ |
   | 1    | ID                 | 否       |                                                        |
   | 2    | 对账单编号         | 是       |                                                        |
   | 3    | 签约客户ID         | 否       |                                                        |
   | 4    | 签约客户名称       | 是       | 1. 前端字段名：签约客户<br />2. 关联渠道商档案表查询   |
   | 5    | 签约主体ID         | 否       |                                                        |
   | 6    | 签约主体名称       | 是       | 1. 前端字段名：签约主体<br />2. 关联甲方基本信息表查询 |
   | 7    | 对账函模板编号     | 否       | 用于判断是否显示开票金额                               |
   | 8    | 数据截止日期       | 是       | YYYY-MM-DD                                             |
   | 9    | 应收款合计（小写） | 是       |                                                        |
   | 10   | 应收款合计（大写） | 是       |                                                        |
   | 11   | 提交人域账号       | 否       |                                                        |
   | 12   | 提交人姓名         | 是       | 关联讯飞用户表查询                                     |
   | 13   | 提交人             | 是       | 后端sql拼接：提交人姓名[提交人域账号]                  |
   | 14   | 对账状态编码       | 否       |                                                        |
   | 15   | 对账状态名称       | 是       | 1. 前端列名：对账状态<br />2. 关联子字典表查询         |
   | 16   | 往来对账明细表DTO  | 是       | 参考下方段说明                                         |

   往来对账明细表DTO字段说明：

   | 序号 | 字段                 | 是否展示 | 备注                                      |
   | ---- | -------------------- | -------- | ----------------------------------------- |
   | 1    | ID                   | 否       |                                           |
   | 2    | 签约主表ID           | 否       |                                           |
   | 4    | 合同名称             | 是       |                                           |
   | 5    | 签约日期             | 是       | YYYY-MM-DD                                |
   | 6    | 合同金额             | 是       |                                           |
   | 7    | 我司已收款金额（元） | 是       |                                           |
   | 8    | 我司未收款金额（元） | 是       |                                           |
   | 9    | 其中应收款金额（元） | 是       |                                           |
   | 10   | 开票金额（元）       | 是       | **根据对账函模板是否有开票金额展示该列**  |
   | 11   | 客户经理域账号       | 否       |                                           |
   | 12   | 客户经理姓名         | 否       | 关联讯飞用户表查询                        |
   | 13   | 客户经理             | 是       | 后端sql拼接：客户经理域账号[客户经理姓名] |

2. 根据往来对账ID查询反馈记录接口，返回反馈记录DTO List

   1. 往来对账反馈记录表左关联附件表，最终得到反馈记录DTO List，其中包括附件DTO List

   2. 查询条件：往来对账ID

   3. 排序：反馈时间升序

   4. 反馈记录DTO：

      | 序号 | 字段         | 是否展示 | 备注                                                         |
      | ---- | ------------ | -------- | ------------------------------------------------------------ |
      | 1    | ID           | 否       |                                                              |
      | 2    | 反馈人账号   | 否       | 渠道商用户ID或讯飞用户域账号                                 |
      | 3    | 反馈人姓名   | 否       |                                                              |
      | 4    | 反馈人       | 是       | 1. 渠道端字段名：反馈人<br />2. 讯飞端字段名：答复人<br />3. 后端sql拼接：反馈人姓名[反馈人域账号] |
      | 5    | 反馈人手机号 | 是       | 只有渠道端用户才有                                           |
      | 6    | 反馈时间     | 是       | 1. 渠道端字段名：反馈时间<br />2. 讯飞端字段名：答复时间<br />3. 格式：YYYY-MM-DD HH:MM:SS |
      | 7    | 反馈意见     | 是       | 1. 渠道端字段名：反馈意见<br />2. 讯飞端字段名：答复内容     |
      | 8    | 附件DTO      | 是       | 通用附件相关信息                                             |

#### 2.2.15.2. 反馈

1. 前端判断对账状态为**待签署、待签署（已答复）**时展示按钮

2. 后端提供**反馈接口**

   1. 参数：往来对账-反馈DTO

      | 序号 | 字段           | 类型 | 是否必填 | 备注                                                         |
      | ---- | -------------- | ---- | -------- | ------------------------------------------------------------ |
      | 1    | 往来对账主表ID | 整数 | 是       |                                                              |
      | 2    | 反馈意见       | 文本 | 是       | 1. 前端字段名：答复内容<br />2. 长度：2000                   |
      | 3    | 附件DTO        | 附件 | 否       | 1. 通用附件上传相关字段<br />2. 非必填<br />3. 类型：txt,pdf,doc,docx,md,bmp,png,jpg,jpeg,gif,xls,xlsx,ppt,pptx,zip,7z<br />4. 大小：200m<br />5. 限制数量：5 |

   2. 后端做相关必填、格式等校验

   3. 根据往来对账主表ID获取往来对账主表数据（不同于查询详情接口，只需调用Mybatis Plus getById方法即可）

   4. 判断是否存在

      1.  不存在，直接返回，提示”操作失败，查询不到数据！“
      2.  若存在，继续执行以下逻辑

   5. 判断当前对账状态是否是**待签署、待签署（已答复）**：

      1.  否，直接返回，提示"当前数据已更改，不可操作！"
      2.  是，继续执行以下逻辑

   6. 设置对账状态：**待签署（待答复）**

   7. 设置更新相关3个字段

   8. 设置反馈记录DTO：

      1. 反馈人账号：当前登陆人ID
      2. 反馈人姓名：当前登陆人姓名
      3. 反馈人手机号：取当前登录人手机号，从LoginUser中获取
      4. 反馈时间：当前时间

   9. 保存往来对账业务数据：

      1. 保存答复记录到反馈记录表
      2. 保存答复附件到附件表
      3. 保存往来对账主表数据

#### 2.2.15.3. 签署

1. 前端判断去签署按钮展示条件：
   1. 对账状态为：**待签署、待签署（待答复）、待签署（已答复）**
   2. 当前登陆人是该渠道商签章授权代表（参考渠道签约）
2. 后端提供**获取契约锁合同签署页面**接口，返回签署页面链接，前端调用后直接浏览器打开

   1. 参数：**ID**
   2. 校验ID必填
   3. 根据ID获取往来对账主表数据（不同于查询详情接口，只需调用Mybatis Plus getById方法即可）
   4. 判断是否存在
      1.  不存在，直接返回，提示”操作失败，查询不到数据！“
      2.  若存在，继续执行以下逻辑
   5. 判断当前对账状态是否是：**待签署、待签署（待答复）、待签署（已答复）**：
      1.  否，直接返回，提示"当前数据已更改，不可操作！"
      2.  是，继续执行以下逻辑
   6. 根据主表数据中的contractId调用契约锁**1.2.2.1 合同签署页面 **接口，返回签署页面链接
3. 参考契约锁接口文档、渠道签约模块

#### 2.2.15.4. 查看对账函

同[讯飞端查看对账函](# 2.2.8.6. 查看对账函)

#### 2.2.15.5. 下载对账函

同[讯飞端下载对账函](# 2.2.8.7. 下载对账函)

### 2.2.16. 对账状态

1. 暂存（编码：0）：批量导入后，未提交
2. 审批中（编码：1）：提交审批，直到审批完成，状态为审批中
3. 驳回（编码：2）：若审批节点驳回，状态变为驳回
4. 已关闭（编码：3）：审批流程驳回至发起人，发起人选择关闭，状态变为已关闭
5. 待签署（编码：4）：审批已完成，待渠道端乙方公司签署，状态变为待签署
6. 待签署（待答复）（编码：4-1）：渠道端乙方公司未签署，反馈意见至讯飞端发起人，状态变为待签署（待答复）
7. 待签署（已答复）（编码：4-2）：讯飞端发起人答复渠道端反馈意见，状态变为待签署（已答复）
8. 已完成（编码：5）：渠道端乙方公司完成签署，状态变为已完成
9. 已撤回（编码：6）：渠道端乙方公司未签署，讯飞端发起人撤回合同，状态变为已撤回
10. 超期已失效（编码：7）：渠道端乙方公司长期未签署，契约锁状态显示超期，同步契约锁状态显示超期已失效

![image-20211129194650054](https://gitee.com/rocky946/pictures/raw/master/img/image-20211129194650054.png)

## 2.3. 互动支持-联系我们

### 2.3.1. 渠道端-应用管理

![image-20211130232925992](https://gitee.com/rocky946/pictures/raw/master/img/image-20211130232925992.png)

菜单权限：在讯飞端-内容管理-应用管理中新建应用，根据业务需求配置权限，应用图标待提供

### 2.3.2. 渠道端-新建

1. 权限：所有用户，包括未登录用户，在讯飞端应用管理里面配置

2. 表单字段：

   | 序号 | 字段         | 类型 | 是否必填 | 备注                                                         |
   | ---- | ------------ | ---- | -------- | ------------------------------------------------------------ |
   | 1    | 公司名称     | 文本 | 是       | 1. 长度：128<br />2. 若为**登录用户**自动带入当前登录人所属公司名称，可编辑<br />3. 后端提供获取当前人所属公司信息 |
   | 2    | 公司所在地   | 文本 | 是       | 1. 长度：512<br />2. 若为**注册用户**自动带入当前登录人所属公司地址，可编辑<br />3. 后端提供获取当前人所属公司信息 |
   | 3    | 联系人姓名   | 文本 | 是       | 1. 长度：50<br />2. 若为**登录用户**自动带入当前登录人姓名，可编辑 |
   | 4    | 联系人电话   | 文本 | 是       | 1. 长度：20<br />2. 若为**登录用户**自动带入当前登录人姓名，可编辑<br />3. 前后端都做手机号格式校验：数字，11位 |
   | 5    | 联系人微信号 | 文本 | -        | 1. 长度：50<br />2. **若为登录用户可选填，非登录用户必填**   |
   | 6    | 联系人邮箱   | 文本 | 是       | 1. 长度：50<br />2. **前后端**都做邮箱格式校验，后端使用`validator @Email`注解，前端参考后端<br />3. 若为**注册用户**自动带入当前登录人所属公司邮箱，可编辑<br />4. 后端提供获取当前人所属公司信息 |
   | 7    | 疑问或建议   | 文本 | 是       | 长度：4000                                                   |
   | 8    | 反馈附件DTO  | 附件 | 否       | 1. 通用附件上传相关字段<br />2. 非必填<br />3. 类型：txt,pdf,doc,docx,md,bmp,png,jpg,jpeg,gif,xls,xlsx,ppt,pptx,zip,7z,mp3,wav,mp4,flv4. <br />4. 大小：200m<br />5. 限制数量：5 |

   **注：将用户类型放入LoginUser中，供前端获取**

3. 前端将以上表单字段提交到后端新建接口：

   1. 后端做相关必填、格式等校验

   2. 校验联系人电话：

      1. 必填校验使用`validator @NotBlank`注解
      2. 格式：数字，11位

   3. 获取接收人：

      1. 根据联系我们管理员角色编码，调用uap通过角色编码获取人员接口，获得对应的负责人
      2. 将负责人保存到接收人字段：姓名[域账号]，多个审批人以英文逗号拼接

   4. 获取当前登录人信息，用户DTO

      > 1. 由于新建功能需开放给未登录用户，所以不能从LoginUser中获取
      > 2. 前端传token，后端使用`JwtUtil.getUsername(token)`获取当前登陆人手机号
      > 3. 根据手机号获取当前登录人信息
      > 4. 参考GoodsShelvesController#downloadFileBatch

   5. 校验联系人微信号：登录用户（用户DTO非空）可选填，非登录用户必填

   7. 设置流程状态：未处理

   8. 设置提交人联系方式：登录用户（用户DTO非空）取用户DTO中手机号字段

   9. 设置创建人账号、更新人账号：登录用户（用户DTO非空）取ID字段

   10. 设置创建人姓名、更新人姓名：登录用户（用户DTO非空）取姓名字段

   11. 设置创建时间、更新时间：当前时间

   12. 保存业务数据到数据库：

       1. 保存附件到附件表
    2. 保存主表数据到联系我们表

### 2.3.3. 渠道端-分页列表

1. 数据权限：登录用户可查看本公司所有数据

2. 查询条件：

   | 序号 | 字段              | 类型       | 备注                                     |
   | ---- | ----------------- | ---------- | ---------------------------------------- |
   | 1    | 公司名称          | 文本       | 模糊查询                                 |
   | 2    | 联系人姓名/手机号 | 文本       | 姓名模糊查询，手机号精确查询             |
   | 3    | 提交时间          | 日期选择框 | YYYY-MM-DD                               |
   | 4    | 处理时间          | 日期选择框 | YYYY-MM-DD                               |
   | 5    | 流程状态          | 下拉框     | 1. 0：未处理；1：已处理<br />2. 精确查询 |

3. 排序：提交时间（创建时间）倒序

4. 分页参数同其它模块

5. 分页列表接口，查询联系我们主表，返回字段：

   | 序号 | 字段         | 是否展示 | 备注                                                         |
   | ---- | ------------ | -------- | ------------------------------------------------------------ |
   | 1    | ID           | 否       |                                                              |
   | 2    | 公司名称     | 是       |                                                              |
   | 3    | 联系人姓名   | 是       |                                                              |
   | 4    | 联系人电话   | 是       |                                                              |
   | 5    | 创建时间     | 是       | 1. 前端字段名：提交时间<br />2. YYYY-MM-DD HH:MM:SS          |
   | 6    | 更新人域账号 | 否       |                                                              |
   | 7    | 更新人姓名   | 否       |                                                              |
   | 8    | 更新人       | 是       | 1. 前端字段名：处理人<br />2. 后端sql拼接：更新人姓名[更新人域账号] |
   | 9    | 更新时间     | 是       | 1. 前端字段名：处理时间<br />2. YYYY-MM-DD HH:MM:SS          |
   | 10   | 流程状态     | 是       | 后端返回0、1，前端自己翻译：0：未处理；1：已处理             |

### 2.3.4. 渠道端-查看详情

后端提供根据ID查询详情接口，查询联系我们主表，返回联系我们DTO

1. 后端做ID必填校验

2. 返回字段：

   | 序号 | 字段           | 是否展示 | 备注                                                         |
   | ---- | -------------- | -------- | ------------------------------------------------------------ |
   | 1    | ID             | 否       |                                                              |
   | 2    | 公司名称       | 是       |                                                              |
   | 3    | 公司所在地     | 是       |                                                              |
   | 4    | 联系人姓名     | 是       |                                                              |
   | 5    | 联系人电话     | 是       |                                                              |
   | 6    | 联系人微信号   | 是       |                                                              |
   | 7    | 联系人邮箱     | 是       |                                                              |
   | 8    | 疑问或建议     | 是       |                                                              |
   | 9    | 反馈附件       | 是       | 1. 前端字段名：附件<br />2. 先查询联系我们详情，再通过ID、附件业务类型获取附件信息DTO，放入联系我们DTO中 |
   | 10   | 创建人账号     | 否       |                                                              |
   | 11   | 创建人姓名     | 是       | 前端字段名：提交人                                           |
   | 12   | 提交人联系方式 | 是       |                                                              |
   | 13   | 创建时间       | 是       | 1. 前端字段名：提交时间<br />2. YYYY-MM-DD HH:MM:SS          |
   | 14   | 接收人         | 是       |                                                              |
   | 15   | 更新人域账号   | 否       |                                                              |
   | 16   | 更新人姓名     | 否       |                                                              |
   | 17   | 更新人         | 是       | 1. 前端字段名：处理人<br />2. 后端sql拼接：更新人姓名[更新人域账号] |
   | 18   | 更新时间       | 是       | 1. 前端字段名：处理时间<br />2. YYYY-MM-DD HH:MM:SS          |
   | 19   | 处理意见       | 是       |                                                              |
   | 20   | 处理附件       | 是       | 1. 前端字段名：附件<br />2. 先查询联系我们详情，再通过ID、附件业务类型获取附件信息DTO，放入联系我们DTO中 |
   | 21   | 流程状态       | 是       | 后端返回0、1，前端自己翻译：0：未处理；1：已处理             |

### 2.3.5. 讯飞端-分页列表

1. 菜单权限：根据业务提供的权限配置文档在uap中配置

2. 数据权限：无

3. 查询条件：

   | 序号 | 字段               | 类型       | 备注                                                         |
   | ---- | ------------------ | ---------- | ------------------------------------------------------------ |
   | 1    | 公司名称           | 文本       | 模糊查询                                                     |
   | 2    | 联系人姓名/手机号  | 文本       | 姓名模糊查询，手机号精确查询                                 |
   | 3    | 提交人账号类型编码 | 下拉框     | 1. 前端字段名：提交人账号类型<br />2. 公共接口，获取子字典<br />3. 精确查询 |
   | 4    | 提交时间           | 日期选择框 | YYYY-MM-DD                                                   |
   | 5    | 处理时间           | 日期选择框 | YYYY-MM-DD                                                   |
   | 6    | 流程状态           | 下拉框     | 1. 0：未处理；1：已处理<br />2. 精确查询                     |

4. 排序：提交时间（创建时间）倒序

5. 分页参数同其它模块

6. 分页列表接口，查询联系我们主表，关联用户表和子字典表查询提交人账号类型，返回字段：

   | 序号 | 字段               | 是否展示 | 备注                                                         |
   | ---- | ------------------ | -------- | ------------------------------------------------------------ |
   | 1    | ID                 | 否       |                                                              |
   | 2    | 公司名称           | 是       |                                                              |
   | 3    | 联系人姓名         | 是       |                                                              |
   | 4    | 联系人电话         | 是       |                                                              |
   | 5    | 提交人账号类型编码 | 否       |                                                              |
   | 6    | 提交人账号类型名称 | 是       | 前端字段名：提交人账号类型                                   |
   | 7    | 创建时间           | 是       | 1. 前端字段名：提交时间<br />2. YYYY-MM-DD HH:MM:SS          |
   | 8    | 更新人域账号       | 否       |                                                              |
   | 9    | 更新人姓名         | 否       |                                                              |
   | 10   | 更新人             | 是       | 1. 前端字段名：处理人<br />2. 后端sql拼接：更新人姓名[更新人域账号] |
   | 11   | 更新时间           | 是       | 1. 前端字段名：处理时间<br />2. YYYY-MM-DD HH:MM:SS          |
   | 12   | 流程状态           | 是       | 后端返回0、1，前端自己翻译，0：未处理；1：已处理             |

### 2.3.6. 讯飞端-导出

1. 菜单权限：根据业务提供的权限配置文档在uap中配置

2. 数据权限、查询条件同分页列表

3. 不分页

4. 列表查询接口，查询联系我们主表，关联用户表和子字典表查询提交人账号类型，返回**联系我们ExcelDTO**：

   | 序号 | 字段               | 是否导出 | 备注                                                         |
   | ---- | ------------------ | -------- | ------------------------------------------------------------ |
   | 1    | ID                 | 否       |                                                              |
   | 2    | 公司名称           | 是       |                                                              |
   | 3    | 公司所在地         | 是       |                                                              |
   | 4    | 联系人姓名         | 是       |                                                              |
   | 5    | 联系人电话         | 是       |                                                              |
   | 6    | 联系人微信号       | 是       |                                                              |
   | 7    | 联系人邮箱         | 是       |                                                              |
   | 8    | 疑问或建议         | 是       |                                                              |
   | 10   | 创建人账号         | 否       |                                                              |
   | 11   | 创建人姓名         | 是       | Excel列名：提交人                                            |
   | 12   | 提交人账号类型编码 | 否       |                                                              |
   | 13   | 提交人账号类型名称 | 是       | 前端字段名：提交人账号类型                                   |
   | 14   | 提交人联系方式     | 是       |                                                              |
   | 15   | 创建时间           | 是       | 1. Excel列名：提交时间<br />2. YYYY-MM-DD HH:MM:SS           |
   | 16   | 流程状态           | 是       | 返回0、1，使用EasyExcel转换器，0：未处理；1：已处理          |
   | 17   | 更新人域账号       | 否       |                                                              |
   | 18   | 更新人姓名         | 否       |                                                              |
   | 19   | 更新人             | 是       | 1. Excel列名：处理人<br />2. 后端sql拼接：更新人姓名[更新人域账号] |
   | 20   | 更新时间           | 是       | 1. Excel列名：处理时间<br />2. YYYY-MM-DD HH:MM:SS           |
   | 21   | 处理意见           | 是       |                                                              |

### 2.3.7. 讯飞端-查看详情

后端提供根据ID查询详情接口，查询联系我们主表，关联用户表和子字典表查询提交人账号类型，返回联系我们DTO

1. 后端做ID必填校验

2. 返回字段：

   | 序号 | 字段               | 是否展示 | 备注                                                         |
   | ---- | ------------------ | -------- | ------------------------------------------------------------ |
   | 1    | ID                 | 否       |                                                              |
   | 2    | 公司名称           | 是       |                                                              |
   | 3    | 公司所在地         | 是       |                                                              |
   | 4    | 联系人姓名         | 是       |                                                              |
   | 5    | 联系人电话         | 是       |                                                              |
   | 6    | 联系人微信号       | 是       |                                                              |
   | 7    | 联系人邮箱         | 是       |                                                              |
   | 8    | 疑问或建议         | 是       |                                                              |
   | 9    | 反馈附件           | 是       | 1. 前端字段名：附件<br />2. 先查询联系我们详情，再通过ID、附件业务类型获取附件信息DTO，放入联系我们DTO中 |
   | 10   | 创建人账号         | 否       |                                                              |
   | 11   | 创建人姓名         | 是       | 前端字段名：提交人                                           |
   | 12   | 提交人账号类型编码 | 否       |                                                              |
   | 13   | 提交人账号类型名称 | 是       | 前端字段名：提交人账号类型                                   |
   | 14   | 提交人联系方式     | 是       |                                                              |
   | 15   | 创建时间           | 是       | 1. 前端字段名：提交时间<br />2. YYYY-MM-DD HH:MM:SS          |
   | 16   | 接收人             | 是       |                                                              |
   | 17   | 更新人域账号       | 否       |                                                              |
   | 18   | 更新人姓名         | 否       |                                                              |
   | 19   | 更新人             | 是       | 1. 前端字段名：处理人<br />2. 后端sql拼接：更新人姓名[更新人域账号] |
   | 20   | 更新时间           | 是       | 1. 前端字段名：处理时间<br />2. YYYY-MM-DD HH:MM:SS          |
   | 21   | 处理意见           | 是       |                                                              |
   | 22   | 处理附件           | 是       | 1. 前端字段名：附件<br />2. 先查询联系我们详情，再通过ID、附件业务类型获取附件信息DTO，放入联系我们DTO中 |
   | 23   | 流程状态           | 是       | 后端返回0、1，前端自己翻译：0：未处理；1：已处理             |

### 2.3.8. 讯飞端-处理

1. 前端判断流程状态为**未处理**时展示按钮

2. 后端提供**处理接口**

   1. 参数：联系我们-处理DTO

      | 序号 | 字段        | 类型 | 是否必填 | 备注                                                         |
      | ---- | ----------- | ---- | -------- | ------------------------------------------------------------ |
      | 1    | ID          | 整数 | 是       |                                                              |
      | 2    | 处理意见    | 文本 | 是       | 长度：4000                                                   |
      | 3    | 处理附件DTO | 附件 | 否       | 1. 通用附件上传相关字段<br />2. 非必填<br />3. 类型：txt,pdf,doc,docx,md,bmp,png,jpg,jpeg,gif,xls,xlsx,ppt,pptx,zip,7z,mp3,wav,mp4,flv4. <br />4. 大小：200m<br />5. 限制数量：5 |

   2. 后端做相关必填、格式等校验

   3. 根据ID获取联系我们表数据（不同于查询详情接口，只需调用Mybatis Plus getById方法即可）

   4. 判断是否存在

      1.  不存在，直接返回，提示”操作失败，查询不到数据！“
      2.  若存在，继续执行以下逻辑

   5. 判断当前流程状态是否是**未处理**：

      1.  否，直接返回，提示"当前数据已更改，不可操作！"
      2.  是，继续执行以下逻辑

   6. 设置流程状态：**已处理**

   7. 设置处理相关字段：

      1. 更新人账号（处理人账号）：当前登陆人域账号
      2. 更新人姓名（处理人姓名）：当前登陆人姓名
      3. 更新时间：当前时间

   8. 保存联系我们业务数据：

      1. 保存处理附件到附件表
      2. 保存联系我们表数据

## 2.2. 合同管理

### 2.2.1. 业务流程

![image-20211202210218609](https://gitee.com/rocky946/pictures/raw/master/img/image-20211202210218609.png)

![image-20211202210253189](https://gitee.com/rocky946/pictures/raw/master/img/image-20211202210253189.png)

### 2.2.2. 签署状态

![image-20211202205220779](https://gitee.com/rocky946/pictures/raw/master/img/image-20211202205220779.png)

1. 对方签署中（编码：3）：到达渠道商签署节点
2. 我司盖章中（编码：5）：乙方先盖章
3. 已完成（编码：7）：甲乙方都签署完成

> 1. 编码定义参考渠道签约-签约状态
> 2. 超期已失效业务暂不考虑

### 2.2.3. 渠道端-应用管理

![image-20211202210339038](https://gitee.com/rocky946/pictures/raw/master/img/image-20211202210339038.png)

菜单权限：在讯飞端-内容管理-应用管理中新建应用，根据业务需求配置权限，应用图标待提供

### 2.2.4. 渠道端-列表页

#### 2.2.4.1. 分页列表

1. 数据权限：

   1. 登录用户可查看本公司所有数据
   2. 可查看**所有签署状态**数据

2. 查询条件：

   | 序号 | 字段         | 类型   | 备注                                                         |
   | ---- | ------------ | ------ | ------------------------------------------------------------ |
   | 1    | 合同ID       | 文本   | 精确查询                                                     |
   | 2    | 合同名称     | 文本   | 模糊查询                                                     |
   | 3    | 签署状态编码 | 下拉框 | 1. 前端字段名：签署状态<br />2. 前端自己实现，3：待签署；5：对方签署中；7：已完成<br />3. 精确查询 |

3. 排序：接收时间（创建时间）倒序

4. 分页列表接口，查询合同管理主表，返回字段：

   | 序号 | 字段         | 是否展示 | 备注                                                         |
   | ---- | ------------ | -------- | ------------------------------------------------------------ |
   | 1    | ID           | 否       |                                                              |
   | 2    | 合同ID       | 是       |                                                              |
   | 3    | 合同名称     | 是       |                                                              |
   | 4    | 创建人账号   | 否       |                                                              |
   | 5    | 创建人姓名   | 否       |                                                              |
   | 6    | 创建人       | 是       | 后端sql拼接：创建人姓名[创建人账号]                          |
   | 7    | 创建时间     | 是       | 1. 前端字段名：接收时间<br />2. YYYY-MM-DD HH:MM:SS          |
   | 8    | 签署状态编码 | 是       | 1. 前端字段名：签署状态<br />2. 前端自己翻译名称，3：待签署；5：对方签署中；7：已完成 |

#### 2.2.4.2. 签署

1. 前端判断去签署按钮展示条件：
   1. 签署状态：**对方签署中**
   2. 当前登陆人是该渠道商签章授权代表（参考渠道签约）
2. 后端提供**获取契约锁合同签署页面**接口，返回签署页面链接，前端调用后直接浏览器打开

   1. 参数：**ID**
   2. 校验ID必填
   3. 根据ID获取合同管理主表数据（不同于查询详情接口，只需调用Mybatis Plus getById方法即可）
   4. 判断是否存在
      1.  不存在，直接返回，提示”操作失败，查询不到数据！“
      2.  若存在，继续执行以下逻辑
   5. 判断当前签署状态是否是：**对方签署中**：
      1.  否，直接返回，提示"当前数据已更改，不可操作！"
      2.  是，继续执行以下逻辑
   6. 根据主表数据中的contractId调用契约锁**1.2.2.1 合同签署页面 **接口，返回签署页面链接
3. 参考契约锁接口文档、渠道签约模块

#### 2.2.4.3. 查看

1. 前端判断签署状态为**已完成**时展示按钮
2. 后端提供**获取契约锁合同浏览页面**接口，返回浏览页面链接，前端调用后直接浏览器打开
   1. 参数：**ID**
   2. 校验ID必填
   3. 根据ID获取合同管理主表数据（不同于查询详情接口，只需调用Mybatis Plus getById方法即可）
   4. 判断是否存在
      1.  不存在，直接返回，提示”操作失败，查询不到数据！“
      2.  若存在，继续执行以下逻辑
   5. 判断当前签署状态是否是：**已完成**：
      1.  否，直接返回，提示"操作失败，当前合同尚未签署完成！"
      2.  是，继续执行以下逻辑
   6. 根据主表数据中的contractId调用契约锁**1.4.1.2 合同浏览页面**接口，返回浏览页面链接
3. 参考契约锁接口文档、渠道签约模块

#### 2.2.4.4.下载

1. 前端判断签署状态为**已完成**时展示按钮
2. 后端提供下载对账函接口：
   1. 参数：**ID**
   2. 校验ID必填
   3. 根据ID获取合同管理主表数据（不同于查询详情接口，只需调用Mybatis Plus getById方法即可）
   4. 判断是否存在
      1.  不存在，直接返回，提示”操作失败，查询不到数据！“
      2.  若存在，继续执行以下逻辑
   5. 判断当前签署状态是否是：**已完成**：
      1.  否，直接返回，提示"操作失败，当前合同尚未签署完成！"
      2.  是，继续执行以下逻辑
   6. 根据主表数据中的contractId调用契约锁**1.4.2.1 下载合同**接口

3. 参考契约锁接口文档、渠道签约模块

### 2.2.5. 讯飞端-列表页

#### 2.2.5.1. 分页列表

1. 菜单权限：根据业务提供的权限配置文档在uap中配置

2. 数据权限：无

3. 查询条件：

   | 序号 | 字段           | 类型   | 备注                                                         |
   | ---- | -------------- | ------ | ------------------------------------------------------------ |
   | 1    | 合同ID         | 文本   | 精确查询                                                     |
   | 2    | 合同名称       | 文本   | 模糊查询                                                     |
   | 3    | 签署状态编码   | 下拉框 | 1. 前端字段名：签署状态<br />2. 公共接口，获取子字典<br />3. 精确查询 |
   | 4    | 所属渠道商名称 | 文本   | 1. 前端字段名：所属渠道商<br />2. 模糊查询                   |

4. 排序：接收时间（创建时间）倒序

5. 分页列表接口，查询合同管理主表，返回字段：

   | 序号 | 字段           | 是否展示 | 备注                                                |
   | ---- | -------------- | -------- | --------------------------------------------------- |
   | 1    | ID             | 否       |                                                     |
   | 2    | 所属渠道商ID   | 否       |                                                     |
   | 3    | 所属渠道商名称 | 是       | 前端字段名：所属渠道商                              |
   | 2    | 合同ID         | 是       |                                                     |
   | 3    | 合同名称       | 是       |                                                     |
   | 4    | 创建人账号     | 否       |                                                     |
   | 5    | 创建人姓名     | 否       |                                                     |
   | 6    | 创建人         | 是       | 后端sql拼接：创建人姓名[创建人账号]                 |
   | 7    | 创建时间       | 是       | 1. 前端字段名：接收时间<br />2. YYYY-MM-DD HH:MM:SS |
   | 8    | 签署状态编码   | 否       |                                                     |
   | 9    | 签署状态名称   | 是       | 1. 前端字段名：签署状态<br />2. 关联子字典查询      |

#### 2.2.5.2. 导出

1. 菜单权限：根据业务提供的权限配置文档在uap中配置

2. 数据权限、查询条件同分页列表

3. 不分页

4. 列表查询接口返回字段：

   | 序号 | 字段         | 是否导出 | 备注                                               |
   | ---- | ------------ | -------- | -------------------------------------------------- |
   | 1    | ID           | 否       |                                                    |
   | 2    | 合同ID       | 是       |                                                    |
   | 3    | 合同名称     | 是       |                                                    |
   | 4    | 创建人账号   | 否       |                                                    |
   | 5    | 创建人姓名   | 否       |                                                    |
   | 6    | 创建人       | 是       | 后端sql拼接：创建人姓名[创建人账号]                |
   | 7    | 创建时间     | 是       | 1. Excel列名：接收时间<br />2. YYYY-MM-DD HH:MM:SS |
   | 8    | 签署状态编码 | 否       |                                                    |
   | 9    | 签署状态名称 | 是       | 1. Excel列名：签署状态<br />2. 关联子字典查询      |

   > 同分页列表接口返回字段，可以考虑使用同一个DTO

#### 2.2.5.4. 查看

同[渠道端查看](#2.2.4.3. 查看)

#### 2.2.5.4. 下载

同[渠道端下载](#2.2.4.4.下载)

### 2.2.6. OA合同信息同步PRM接口

1. 提供给OA103盖章流程流转到外部渠道商签署节点前调用，将合同信息写到PRM

2. 参数：

   | 序号 | 字段           | 字段说明             | 校验                                                         | 备注                 |
   | ---- | -------------- | -------------------- | ------------------------------------------------------------ | -------------------- |
   | 1    | 所属渠道商名称 | 文本，渠道商公司名称 | 1. 必填；长度：128<br />2. 渠道商档案表中存在，且是启用状态<br />3. 已完成电子签认证 | 将名称转换为渠道商ID |
   | 2    | 合同ID         | 文本                 | 必填；**大整数**                                             |                      |
   | 3    | 合同名称       | 文本                 | 必填；长度：128                                              |                      |
   | 4    | 创建人账号     | 文本                 | 1. 必填；长度：50<br />2. 域账号是否存在。先校验讯飞用户表是否存在，若不存在再调用PS接口。此处可使用公共的获取用户方法，已包含上述逻辑 | 创建人域账号         |

3. 接口逻辑：

   1. 校验必填、长度、格式等
   2. 校验渠道商，查询渠道商ID，**后端同时存所属渠道商ID、所属渠道商名称**
   3. 校验创建人账号（域账号），查询创建人姓名，**后端同时存创建人账号、创建人姓名**
   4. 设置签署状态：对方签署中
   5. 设置创建时间：当前时间，`new Date()`
   6. 设置更新相关3个字段：与创建相关3个字段同值
   7. 保存业务数据到合同管理表


### 2.2.7. 获取渠道商电签状态接口

1. 提供给CRM定时任务获取**所有渠道商**电签状态
2. **暂不考虑禁用渠道商**
3. 参数：无
4. 接口逻辑：查询渠道商档案表，接口返回字段：
   1. 渠道商ID（CHANNEL_ID）
   2. 渠道商名称
   3. CRM渠道商编码
   4. 电子签认证状态：UNPASSED：未认证；PASSED：认证通过

### 2.2.8. 获取渠道商签章授权代表接口

1. 提供给OA在创建契约锁合同的时候调用
2. 参数：所属渠道商名称（必填）
3. 接口逻辑：
   1. 校验所属渠道商必填
   2. 查询渠道商档案表，左关联渠道商用户表，获取用户信息，条件：
      1. 渠道商名称
      2. 渠道商电签状态：认证通过
      3. 用户状态：启用
      4. 用户是否电签约负责人：是
   3. 判断查询结果是否为空
      1. 是：查询失败，返回“未查询到该渠道商签章授权代表信息”
      2. 否：接口返回字段：用户姓名、用户手机号

### 2.2.9. 签署状态回调接口（待定）

1. 回调场景：

   1. 乙方先签，甲方签署后
   2. 乙方先签，乙方签署后

2. 契约锁或OA**（待定，TODO）**回调PRM接口，将签署状态改为：我司盖章中、已完成

3. 后端提供回调接口

   1. 参数：

      | 序号 | 字段       | 类型   | 是否必填 | 备注                                             |
      | ---- | ---------- | ------ | -------- | ------------------------------------------------ |
      | 1    | contractId | 字符串 | 是       | 合同ID                                           |
      | 2    | status     | 字符串 | 是       | COMPLETE: 完成；SIGNING: 签署中；EXPIRED: 已过期 |

   2. 校验contractId、status必填

   3. 根据contractId获取合同管理主表数据

   4. 判断是否存在：

      1.  不存在，直接返回，提示”操作失败，查询不到数据！“
      2.  若存在，继续执行以下逻辑

   5. 判断当前签署状态是否是：**已完成**：

      1.  是，直接返回，提示"当前数据已更改，不可操作！"
      2.  否，继续执行以下逻辑

   6. 设置签署状态：我司盖章中/已完成

   7. 设置更新相关3个字段:

      1. 更新人账号：qys
      2. 更新人姓名：契约锁
      3. 更新时间：当前时间，new Date()

    8. 保存合同管理主表数据

## 2.3. 简化签约

### 2.3.1. 审批流程

![image-20211201235331596](https://gitee.com/rocky946/pictures/raw/master/img/image-20211201235331596.png)

1. 标黄为简化签约审批流程，其它同PRM1.0签约审批流程

2. 在T_WORKFLOW_NODE[流程节点]表中配置复核人节点

3. 渠道签约申请表添加字段：签约类型，0：标准签约；1：简化签约

   > **上线时需将历史数据全部刷成0**

4. 复核人节点

   1. 审批按钮：同意、不同意、转办、加签（多人会签）
   2. **在签约审批人设置模块设置审批人**
   3. 审批同意后系统**判断是否为模板协议**，若为模板协议，自动抄送至甲方业务负责人（调用流程引擎传阅接口）

5. 法务节点

   1. 审批同意后，**判断是否为模板协议**，若为非模板协议，自动抄送至甲方业务负责人（调用流程引擎传阅接口）

### 2.3.2. 讯飞端-签约查看与新增

#### 2.3.2.1. 简化签约

1. 新建签约表单添加隐藏参数：签约类型
2. 按钮权限：根据业务提供的权限配置文档在uap中配置
3. 前端点击新建按钮，自动将签约类型置为0（标准签约）；点击简化签约按钮则置为1（简化签约），提交时将该字段传至后端接口
4. 后端创建流程接口调整：
   1. 参数添加：签约类型
   2. 查询签约审批人表，若签约类型为0（标准签约），查询渠道管理员节点审批人；若为1（简化签约），查询复核人节点审批人。将查询到的审批人域账号（多个以英文逗号拼接）传至流程引擎创建流程接口**participantsLoginName（参与者域账号）**字段中
   3. 将签约类型传至流程引擎创建流程接口**mainTblData（主表数据）**字段中

#### 2.3.2.1. 分页列表

1. 查询条件新增：

   | 序号 | 字段     | 类型   | 备注                                         |
   | ---- | -------- | ------ | -------------------------------------------- |
   | 1    | 签约类型 | 下拉框 | 1. 0：标准签约；1：简化签约<br />2. 精确查询 |

2. 分页列表接口，返回字段添加：

   | 序号 | 字段     | 是否展示 | 备注                                                 |
   | ---- | -------- | -------- | ---------------------------------------------------- |
   | 1    | 签约类型 | 是       | 后端返回0、1，前端自己翻译，0：标准签约；1：简化签约 |

#### 2.3.2.3. 导出

列表查询接口，返回字段添加：

| 序号 | 字段     | 是否展示 | 备注                                                    |
| ---- | -------- | -------- | ------------------------------------------------------- |
| 1    | 签约类型 | 是       | 返回0、1，使用EasyExcel转换器，0：标准签约；1：简化签约 |

### 2.3.3. 讯飞端-审批

#### 2.3.3.1. 复核人节点

后端流程审批接口调整：

1. 参数添加：签约类型
2. 判断是否模板协议：
   1. 是：归档，执行审批完成业务逻辑
   2. 否：查询签约审批人表，查询法务节点审批人。将查询到的审批人域账号（多个以英文逗号拼接）传至流程引擎创建流程接口**participantsLoginName（参与者域账号）**字段中
3. 调用流程引擎提交流程实例接口**后**，判断是否模板协议：
   1. **是**：抄送**甲方业务负责人**，调用流程引擎**传阅任务**接口
   2. 否：结束执行

#### 2.3.3.2. 法务节点

后端流程审批接口调整：

1. 参数添加：签约类型
2. 判断签约类型：
   1. 标准签约：查询签约审批人表，判断是否非区域平台管理（**以前的逻辑不变**）：若为是，查询非区域营销平台渠道业务分发人节点审批人。将查询到的审批人域账号（多个以英文逗号拼接）传至流程引擎创建流程接口**participantsLoginName（参与者域账号）**字段中
   2. 简化签约：归档，执行审批完成业务逻辑
3. 调用流程引擎提交流程实例接口**后**，判断签约类型：
   1. 标准签约：结束执行
   2. 简化签约：抄送**甲方业务负责人**，调用流程引擎**传阅任务**接口

### 2.3.4. i讯飞待办

页面、接口等调整同讯飞端

## 2.4. 待办中心

1. 前端新建待办中心菜单，菜单权限同签约审批，删除签约审批菜单

2. 前端新增下拉框：待办、已办、待阅、已阅

3. 前端根据url进行页面跳转、按钮控制：

   1. url前缀
   2. **flowStatus**：
      1. UndoProcess：待办
      2. DoneProcess：已办
      3. UnRead：待阅
      4. Read：已阅

4. 后端新增获取待阅、已阅接口

   1. 待办：流程引擎-获取待办列表接口
   2. 已办：流程引擎-获取已办流程列表接口
   3. **待阅**：流程引擎-待阅任务列表接口
   4. **已阅**：流程引擎-已阅任务列表接口

5. T_WORKFLOW_BASE[流程基本信息]表新增字段：流程来源（PRM、OA），用于区分PRM、流程引擎。并提供查询列表接口，前端在流程tab页渲染和查询条件中使用

6. 分页列表：

   1. 查询条件：

      | 序号 | 字段     | 类型   | 备注         |
      | ---- | -------- | ------ | ------------ |
      | 1    | 流程编码 | 下拉框 | 后端提供接口 |
      | 2    | 标题     | 文本   | 模糊查询     |

   2. 排序：接收时间/操作时间倒序

   3. 分页参数同其它模块

   4. 分页列表接口返回WorkflowInfoVo：

      ```java
      package com.ifly.qxb.exchange.wfengine.entity.workflow.vo;
      
      import com.fasterxml.jackson.annotation.JsonIgnoreProperties;
      import lombok.*;
      
      import java.io.Serializable;
      
      /**
       * <p>
       * <code>WorkflowInfoVo</code>
       * </p>
       * Description:流程信息实体
       *
       * @author junliang2
       * @date 2020/10/10 17:54
       */
      @Data
      @Builder
      @NoArgsConstructor(access = AccessLevel.PRIVATE)
      @AllArgsConstructor(access = AccessLevel.PRIVATE)
      @JsonIgnoreProperties(ignoreUnknown = true)
      public class WorkflowInfoVo implements Serializable {
          private static final long serialVersionUID = -4590048839745541675L;
          /**
           * 任务标识
           */
          private String id;
          /**
           * 任务标识
           */
          private String taskId;
          /**
           * 当前节点名称
           */
          private String name;
          /**
           * 当前节点编码
           */
          private String taskDefinitionKey;
          /**
           * 当前节点编码
           */
          private String curTaskCode;
          /**
           * 流程分类
           */
          private String category;
          /**
           * 流程分类名称
           */
          private String categoryName;
          /**
           * 创建时间
           */
          private String createTime;
          /**
           * 接收时间
           */
          private String claimTime;
          /**
           * 办理期限
           */
          private String dueDate;
          /**
           * 表单 key
           */
          private String formKey;
          /**
           * 外部表单
           */
          private String formUrl;
          /**
           * 外部关联表单链接
           */
          private String extrovertedFormUrl;
          /**
           * 移动端地址
           */
          private String formUrlMobile;
          /**
           * 外部关联表单链接
           */
          private String extrovertedformUrlMobile;
          /**
           * 单位 id
           */
          private String tenantId;
          /**
           * 流程实例 id
           */
          private String processInstanceId;
          /**
           * 环节办理人
           */
          private String assignee;
          /**
           * 环节办理人名称
           */
          private String assigneeName;
          /**
           * 环节办理人域账号
           */
          private String assigneeLoginName;
          /**
           * 业务数据id
           */
          private String businessKey;
          /**
           * 流程名称
           */
          private String processName;
          /**
           * 流程 key
           */
          private String processKey;
          /**
           * 发起人 id
           */
          private String startUserId;
          /**
           * 发起人名称
           */
          private String startUserName;
          /**
           * 发起人 域账号
           */
          private String startUserLoginName;
          /**
           * 发起人组织 id
           */
          private String startUserGroupId;
          /**
           * 发起人组织名称
           */
          private String startUserGroupName;
          /**
           * 长组织名
           */
          private String startUserGroupNameFull;
          /**
           * 标题
           */
          private String title;
          /**
           * 紧急程度
           */
          private String urgency;
          /**
           * 图标
           */
          private String icon;
          /**
           * 1：暂不处理
           */
          private String deleted;
      
          /**
           * 任务类型，consult为征询任务
           */
          private String taskType;
      }
      ```

7. 参考流程引擎接口文档、签约审批模块

## 2.5. 优化需求

#### 2.5.1. 电子签认证变更

已开发完成并上线，后期待**刘睿**补充详细设计

#### 2.5.2. 渠道商注册变更字段对比

已开发完成并上线，后期待**孙进磊**补充详细设计

#### 2.5.3. 渠道商档案详情页i讯飞端

已开发完成并上线，后期待**孙进磊**补充详细设计

#### 2.5.4. 物理章模板本地预览

已开发完成并上线，后期待**孙进磊**补充详细设计

#### 2.5.5. 渠道签约合同超期状态更新

1. 调整原PRM-契约锁集成签署完成回调接口，添加超期已失效状态
2. 契约锁在签约协议到期时回调PRM接口，PRM更新签约状态、更相相关字段

#### 2.5.6. PRM-OA集成签约状态回调

1. 调整原PRM-契约锁集成乙方签署完成回调接口
   1. 当电子签非模板协议、乙方先签，取消甲方静默签署，签约状态改成：我司盖章中
2. 开发PRM-OA集成签约状态回调接口，提供给OA在103盖章流程调用：电子签非模板协议、乙方先签，甲方盖章节点后，签署状态改成：已完成
3. 渠道端列表添加一个状态：我司盖章中，在渠道端显示成（对方签约中）

# 3. 数据库设计

参考gti management《management\05.Design\详细设计\PRM数据库设计.pdman.json》

# 4. 字典设计

参考git management《management\05.Design\详细设计\数据字典详细设计文档》
